<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line å®¢æˆ¶åå–®æŒ‡æ´¾ä¸­å¿ƒ</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®šå­—é«”ç‚º Inter (æˆ–ç³»çµ±é è¨­çš„ç„¡è¥¯ç·šå­—é«”) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f7f7;
            overflow: hidden; /* é˜²æ­¢ä¸»é«”æ»¾å‹• */
        }
        /* æ¨¡æ“¬ Line å°è©±å€èƒŒæ™¯ */
        .line-chat-bg {
            background-color: #E7EDF5;
        }
        /* è‡ªå®šç¾©ç¦ç”¨ç‹€æ…‹çš„æ¨£å¼ */
        .input-disabled-custom {
            background-color: #e0e0e0;
            color: #777;
            cursor: not-allowed;
            border-color: #c0c0c0;
        }
    </style>
</head>
<body>

    <!-- ä¸»ç®¡æ´¾ç™¼å€ (æœ€ä¸Šæ–¹çš„ Line ç¶ è‰²å€åŸŸ) -->
    <header class="bg-teal-600 text-white shadow-xl p-3 md:p-4 sticky top-0 z-20">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between space-y-3 md:space-y-0">
            <h1 class="text-xl font-bold font-extrabold tracking-wider">ğŸ“ å®¢æˆ¶åå–®æŒ‡æ´¾ä¸­å¿ƒ (ä¸»ç®¡è¦–è§’)</h1>

            <!-- æŒ‡æ´¾åŠŸèƒ½å€å¡Š -->
            <div class="flex items-center space-x-3 w-full md:w-auto">
                <!-- é¸å–å®¢æˆ¶ -->
                <select id="client-select" class="p-2 border border-teal-500 rounded-lg text-gray-800 bg-white shadow-inner focus:ring-2 focus:ring-lime-300 transition duration-150">
                    <option value="" disabled selected>--- é¸å–å®¢æˆ¶åå–® ---</option>
                    <option value="A001">å¼µå…ˆç”Ÿ (é«˜æ½›åŠ›)</option>
                    <option value="B002">ç‹å°å§ (å¾…è¯ç¹«)</option>
                    <option value="C003">æç¶“ç† (å·²å ±åƒ¹)</option>
                </select>

                <!-- æŒ‡æ´¾å°ˆå“¡ (æ›´æ–°åç¨±) -->
                <select id="agent-select" class="p-2 border border-teal-500 rounded-lg text-gray-800 bg-white shadow-inner focus:ring-2 focus:ring-lime-300 transition duration-150">
                    <option value="" disabled selected>--- æŒ‡æ´¾çµ¦å°ˆå“¡ ---</option>
                    <option value="Agent1">å°ç‘„ (ç·šä¸Š)</option>
                    <option value="Agent2">å°éœ– (å¿™ç¢Œ)</option>
                    <option value="Agent3">å°å³ (ä¼‘å‡)</option>
                    <option value="Agent4">å°ç”„ (æ–°é€²)</option>
                </select>

                <!-- æŒ‡æ´¾æŒ‰éˆ• (æ›´æ–°é…è‰²) -->
                <button onclick="assignClient()" class="bg-lime-300 hover:bg-lime-400 text-teal-900 font-extrabold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-300 transform hover:scale-105 whitespace-nowrap">
                    æŒ‡æ´¾ä¸¦å•Ÿå‹•å°è©±
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»å…§å®¹å€ (ä¸‰æ¬„ä½ˆå±€) -->
    <main class="h-[calc(100vh-80px)] overflow-hidden">
        <div class="grid grid-cols-12 h-full">

            <!-- è¼”åŠ©å€å¡Š - å·¦å´ï¼šå¾…æŒ‡æ´¾å®¢æˆ¶åå–® -->
            <aside class="col-span-12 md:col-span-3 bg-white border-r border-gray-200 shadow-inner flex flex-col p-4 overflow-y-auto">
                <!-- åç¨±å·²æ›´æ–° -->
                <h2 class="text-lg font-semibold mb-3 text-teal-700 border-b pb-2">ğŸ“‚ å¾…æŒ‡æ´¾å®¢æˆ¶åå–®</h2>

                <!-- æœç´¢/éæ¿¾å™¨ -->
                <input type="text" placeholder="æœå°‹å®¢æˆ¶åç¨±/ç·¨è™Ÿ..." class="p-2 mb-4 border border-gray-300 rounded-lg focus:ring-teal-400 focus:border-teal-400">

                <!-- å®¢æˆ¶åˆ—è¡¨å®¹å™¨ -->
                <div id="client-list-container" class="space-y-2 flex-grow">
                    <!-- åˆ—è¡¨é …ç›® (ä½¿ç”¨ JS é¸æ“‡æ™‚ï¼Œæœƒé«˜äº®é¡¯ç¤º) -->
                    <div class="client-item p-3 bg-gray-50 hover:bg-teal-50 rounded-lg shadow-sm cursor-pointer border-l-4 border-transparent transition duration-200" data-client-id="A001">
                        <p class="font-medium text-gray-800">å¼µå…ˆç”Ÿ <span class="text-xs text-gray-500 ml-2">#A001</span></p>
                        <span class="text-xs font-semibold px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded-full">é«˜æ½›åŠ›åå–®</span>
                        <span class="text-xs text-gray-500 block mt-1">ä¸Šæ¬¡å°ˆå“¡: å°éœ– (2å°æ™‚å‰æ›´æ–°)</span>
                    </div>

                    <div class="client-item p-3 bg-white hover:bg-teal-50 rounded-lg shadow-sm cursor-pointer border-l-4 border-teal-500 transition duration-200 active-client" data-client-id="D004">
                        <p class="font-medium text-teal-700">æ—å…ˆç”Ÿ <span class="text-xs text-gray-500 ml-2">#D004</span></p>
                        <span class="text-xs font-semibold px-2 py-0.5 bg-green-100 text-green-800 rounded-full">é€²è¡Œä¸­å°è©±</span>
                        <span class="text-xs text-gray-500 block mt-1 font-bold text-teal-600">ç›®å‰è² è²¬: æ‚¨ (5åˆ†é˜å‰æ›´æ–°)</span>
                    </div>

                    <div class="client-item p-3 bg-gray-50 hover:bg-teal-50 rounded-lg shadow-sm cursor-pointer border-l-4 border-transparent transition duration-200" data-client-id="B002">
                        <p class="font-medium text-gray-800">ç‹å°å§ <span class="text-xs text-gray-500 ml-2">#B002</span></p>
                        <span class="text-xs font-semibold px-2 py-0.5 bg-red-100 text-red-800 rounded-full">å¾…å›è¦†</span>
                        <span class="text-xs text-gray-500 block mt-1">ä¸Šæ¬¡å°ˆå“¡: å°ç‘„ (æ˜¨æ—¥æ›´æ–°)</span>
                    </div>

                    <div class="client-item p-3 bg-gray-50 hover:bg-teal-50 rounded-lg shadow-sm cursor-pointer border-l-4 border-transparent transition duration-200" data-client-id="E005">
                        <p class="font-medium text-gray-800">è¶™å°å§ <span class="text-xs text-gray-500 ml-2">#E005</span></p>
                        <span class="text-xs font-semibold px-2 py-0.5 bg-gray-300 text-gray-800 rounded-full">æ–°åå–®</span>
                        <span class="text-xs text-gray-500 block mt-1 text-red-500 font-medium">ä¸Šæ¬¡å°ˆå“¡: æœªæŒ‡æ´¾</span>
                    </div>
                </div>
            </aside>

            <!-- Line å°è©±å€ (Chat Interface) -->
            <section class="col-span-12 md:col-span-6 flex flex-col line-chat-bg border-x border-gray-300 h-full">
                <!-- å°è©±æ¨™é¡Œ (Header) -->
                <div class="p-4 bg-white shadow-md border-b border-gray-200 flex justify-between items-center z-10">
                    <h2 class="text-xl font-bold text-gray-800">æ—å…ˆç”Ÿ (Line ID: customer_lin)</h2>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-green-600 flex items-center">
                            <svg class="w-4 h-4 mr-1 fill-current" viewBox="0 0 20 20"><path d="M10 20a10 10 0 1 1 0-20 10 10 0 0 1 0 20zm5-11H5V9h10v1z"/></svg>
                            ç·šä¸Š
                        </span>
                        <!-- å°è©±ç‹€æ…‹è¦–è¦ºåŒ– -->
                        <span id="chat-status-visual" class="text-sm font-bold px-2 py-0.5 rounded-full bg-green-100 text-green-600">å°è©±ä¸­</span>
                    </div>
                </div>

                <!-- è¨Šæ¯æ°£æ³¡åˆ†æ˜å€ (Messages) -->
                <div id="chat-messages" class="flex-grow p-5 overflow-y-auto space-y-4">
                    <!-- å®¢æˆ¶è¨Šæ¯æ°£æ³¡ (ç™½è‰²/å·¦å´) -->
                    <div class="flex justify-start">
                        <div class="max-w-xs md:max-w-md bg-white p-3 rounded-t-xl rounded-br-xl shadow-md border border-gray-200">
                            <p class="text-gray-700">æ‚¨å¥½ï¼Œæˆ‘å°ä½ å€‘ç¶²ç«™ä¸Šé‚£å€‹ã€Œæ™ºæ…§å‹æŠ•è³‡çµ„åˆã€æ–¹æ¡ˆå¾ˆæ„Ÿèˆˆè¶£ï¼Œå¯ä»¥å¤šä»‹ç´¹ä¸€ä¸‹å—ï¼Ÿ</p>
                            <span class="block text-xs text-gray-400 mt-1 text-right">09:30 AM</span>
                        </div>
                    </div>

                    <!-- å°ˆå“¡è¨Šæ¯æ°£æ³¡ (Lineé¢¨æ ¼ç¶ è‰²/å³å´) -->
                    <div class="flex justify-end">
                        <div class="max-w-xs md:max-w-md bg-[#D4F8C8] p-3 rounded-t-xl rounded-bl-xl shadow-md border border-green-200">
                            <p class="text-gray-800">æ—å…ˆç”Ÿæ‚¨å¥½ï¼Œæˆ‘æ˜¯å°ˆå“¡ [æ‚¨çš„åå­—]ã€‚å¾ˆé«˜èˆˆèƒ½ç‚ºæ‚¨æœå‹™ï¼é€™å€‹æ–¹æ¡ˆéå¸¸é©åˆæ‚¨ç›®å‰çš„éœ€æ±‚ï¼Œå®ƒæœ‰å…©å€‹æ ¸å¿ƒå„ªå‹¢...</p>
                            <span class="block text-xs text-gray-500 mt-1 text-right">09:35 AM âœ“âœ“</span>
                        </div>
                    </div>

                    <!-- å®¢æˆ¶è¨Šæ¯ -->
                    <div class="flex justify-start">
                        <div class="max-w-xs md:max-w-md bg-white p-3 rounded-t-xl rounded-br-xl shadow-md border border-gray-200">
                            <p class="text-gray-700">å–”ï¼Œè½èµ·ä¾†ä¸éŒ¯ã€‚è«‹å•èµ·å§‹æŠ•è³‡é–€æª»æ˜¯å¤šå°‘ï¼Ÿ</p>
                            <span class="block text-xs text-gray-400 mt-1 text-right">09:38 AM</span>
                        </div>
                    </div>

                </div>

                <!-- è¼¸å…¥å€å¡Š (Input) - åˆå§‹è¨­å®šç‚ºå…¶ä»–éƒ¨é–€è¼¸å…¥ä¸­ -->
                <div class="p-3 bg-white border-t border-gray-200 flex items-center space-x-2">
                    <input type="text" id="chat-input" 
                        placeholder="å®¢æœ æ™ºå¯¶ è¼¸å…¥è¨Šæ¯ä¸­" 
                        disabled 
                        class="flex-grow p-3 rounded-full input-disabled-custom focus:ring-teal-500 focus:border-teal-500 transition duration-150">
                    
                    <!-- ç™¼é€æŒ‰éˆ•æ›´æ–°é…è‰² -->
                    <button onclick="sendMessage()" id="send-btn" disabled 
                        class="bg-gray-400 text-white p-3 rounded-full shadow-lg transition duration-300 flex-shrink-0 cursor-not-allowed">
                        <!-- Send Icon SVG -->
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </section>

            <!-- è¼”åŠ©å€å¡Š - å³å´ï¼šCRM è³‡æ–™é¢æ¿ -->
            <aside class="col-span-12 md:col-span-3 bg-gray-50 border-l border-gray-200 shadow-inner flex flex-col p-4 overflow-y-auto">
                <h2 class="text-lg font-semibold mb-3 text-teal-700 border-b pb-2">ğŸ¯ CRM è³‡æ–™é¢æ¿ (æ—å…ˆç”Ÿ)</h2>

                <div id="crm-panel-content" class="space-y-4">

                    <!-- åå–®éŠ·å”®ç‹€æ…‹ -->
                    <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-red-500">
                        <h3 class="font-bold text-gray-700 mb-2">â­ åå–®éŠ·å”®ç‹€æ…‹ (Sales Funnel)</h3>
                        <label for="list-status" class="text-sm block mb-1 text-gray-600">è®Šæ›´åå–®ç‹€æ…‹:</label>
                        <select id="list-status" class="w-full p-2 border border-gray-300 rounded-lg mb-3 focus:ring-red-400 focus:border-red-400">
                            <option>1. æ–°ç·šç´¢/æœªè™•ç†</option>
                            <option selected>2. è¯ç¹«ä¸­ (é›»è©±/Line)</option>
                            <option>3. å·²å ±åƒ¹/ææ¡ˆ</option>
                            <option>4. è­°åƒ¹/åˆç´„éšæ®µ</option>
                            <option value="WON">5. å·²æˆäº¤ (WON)</option>
                            <option>6. å¤±æ•—/æµå¤± (LOST)</option>
                        </select>
                    </div>

                    <!-- å°è©±ç‹€æ…‹ç®¡ç† (çµæŸ/é–‹å•Ÿæ©Ÿåˆ¶) -->
                    <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-teal-500">
                        <h3 class="font-bold text-gray-700 mb-2">âœ… å°è©±ç‹€æ…‹ç®¡ç† (éƒ¨é–€äº¤æ¥)</h3>
                        <p id="conversation-status-indicator" class="text-lg font-bold mb-3 text-green-600">ç‹€æ…‹: é€²è¡Œä¸­</p>

                        <!-- çµæŸæŒ‰éˆ• -->
                        <button onclick="toggleConversationStatus(true)" id="close-conversation-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition duration-150 shadow-md">
                            âœ… çµæŸç•¶å‰å°è©± (å·²å®Œæˆ)
                        </button>
                        <!-- é‡æ–°é–‹å•ŸæŒ‰éˆ• (é è¨­éš±è—) -->
                        <button onclick="toggleConversationStatus(false)" id="open-conversation-btn" class="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition duration-150 shadow-md hidden">
                            ğŸ’¬ é‡æ–°é–‹å•Ÿå°è©± (éœ€è·Ÿé€²)
                        </button>
                    </div>

                    <!-- è¼¸å…¥æ§åˆ¶æ¬Š (æ–°å¢çš„é—œéµå€å¡Š) -->
                    <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-purple-500">
                        <h3 class="font-bold text-gray-700 mb-2">âŒ¨ï¸ å°è©±æ§åˆ¶æ¬Š</h3>
                        <!-- é è¨­é¡¯ç¤ºå…¶ä»–éƒ¨é–€è¼¸å…¥ä¸­ -->
                        <p id="control-status" class="text-sm font-bold mb-3 text-red-500">ç›®å‰ç‹€æ…‹: å®¢æœ æ™ºå¯¶ è¼¸å…¥ä¸­...</p>
                        <button onclick="takeControl()" id="take-control-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 rounded-lg transition duration-150 shadow-md">
                            ğŸ’¡ å–å¾—ç™¼è¨€æ¬Š (æ¥æ‰‹)
                        </button>
                        <button onclick="releaseControl()" id="release-control-btn" class="w-full mt-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-lg transition duration-150 shadow-md hidden">
                            â¡ï¸ é‡‹æ”¾ç™¼è¨€æ¬Š (å®Œæˆ)
                        </button>
                    </div>

                    <!-- åŸºæœ¬è³‡è¨Š -->
                    <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-teal-500">
                        <h3 class="font-bold text-gray-700 mb-2">åŸºæœ¬è³‡æ–™èˆ‡æ½›åŠ›</h3>
                        <p class="text-sm">å®¢æˆ¶ç·¨è™Ÿ: <span class="font-mono text-teal-600">#D004</span></p>
                        <p class="text-sm">é€£çµ¡é›»è©±: <span class="font-mono text-gray-600">09xx-xxx-999</span></p>
                        <p class="text-sm">è¡Œæ¥­åˆ¥: <span class="font-medium text-gray-600">ç§‘æŠ€æ¥­ä¸»ç®¡</span></p>
                        <p class="text-sm">æ½›åŠ›è©•ç´š: <span class="font-extrabold text-red-500">A+ (æ¥µé«˜)</span></p>
                    </div>

                    <!-- ä¸‹æ¬¡è¿½è¹¤æ™‚é–“ -->
                    <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-yellow-500">
                        <h3 class="font-bold text-gray-700 mb-2">â° ä¸‹æ¬¡è¿½è¹¤æ’ç¨‹</h3>
                        <label for="followup-time" class="text-sm block mb-1 text-gray-600">æé†’æ™‚é–“:</label>
                        <input type="datetime-local" id="followup-time" value="2025-11-01T10:00" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-yellow-400 focus:border-yellow-400">
                    </div>
                    
                    <!-- CRM å„²å­˜æŒ‰éˆ• -->
                    <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-gray-300">
                        <button onclick="updateCrmFields()" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 rounded-lg transition duration-150 shadow-md">
                            å„²å­˜æ‰€æœ‰ CRM è®Šå‹•
                        </button>
                    </div>
                </div>
            </aside>

        </div>
    </main>

    <!-- JavaScript ç°¡æ˜“äº’å‹•é‚è¼¯ -->
    <script>
        // å…¨å±€è®Šæ•¸
        let activeClient = 'D004';
        let isConversationClosed = false; // ç¸½é«”å°è©±ç‹€æ…‹ (å·²çµæŸ/é€²è¡Œä¸­)
        let isCurrentDeptActive = false; // è¼¸å…¥æ§åˆ¶æ¬Š (æ‚¨/å…¶ä»–éƒ¨é–€)
        
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const sendButton = document.getElementById('send-btn');
        
        const closeBtn = document.getElementById('close-conversation-btn');
        const openBtn = document.getElementById('open-conversation-btn');
        const chatStatusVisual = document.getElementById('chat-status-visual');
        const crmStatusIndicator = document.getElementById('conversation-status-indicator');
        const listStatusSelect = document.getElementById('list-status');

        const takeControlBtn = document.getElementById('take-control-btn');
        const releaseControlBtn = document.getElementById('release-control-btn');
        const controlStatus = document.getElementById('control-status');


        // åˆå§‹åŒ–ï¼šè¨­ç½®ç•¶å‰æ´»å‹•å®¢æˆ¶çš„æ¨£å¼
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.client-item').forEach(item => {
                item.addEventListener('click', () => {
                    const clientId = item.getAttribute('data-client-id');
                    setActiveClient(clientId);
                });
            });
            // ç›£è½ Enter éµç™¼é€è¨Šæ¯
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // è¨­ç½®ä¸‹æ¬¡è¿½è¹¤æ™‚é–“çš„é è¨­å€¼
            const followupTimeInput = document.getElementById('followup-time');
            if (followupTimeInput) {
                const now = new Date();
                now.setDate(now.getDate() + 1);
                now.setHours(10, 0, 0, 0);
                const isoString = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().substring(0, 16);
                followupTimeInput.value = isoString;
            }
            
            // ç”±æ–¼ HTML å·²ç¶“è¨­å®šç‚ºåˆå§‹æƒ…å¢ƒ (å…¶ä»–éƒ¨é–€è¼¸å…¥ä¸­)ï¼Œé€™è£¡åªéœ€åœ¨ JS ä¸­åŒæ­¥ç‹€æ…‹
            isCurrentDeptActive = false; 
        });

        // æ¨¡æ“¬åˆ‡æ›å®¢æˆ¶ (æ›´æ–° UI é«˜äº®)
        function setActiveClient(newClientId) {
            document.querySelectorAll('.client-item').forEach(item => {
                item.classList.remove('active-client', 'border-teal-500', 'bg-white');
                item.classList.add('bg-gray-50', 'border-transparent');
            });

            const newItem = document.querySelector(`.client-item[data-client-id="${newClientId}"]`);
            if (newItem) {
                newItem.classList.add('active-client', 'border-teal-500', 'bg-white');
                newItem.classList.remove('bg-gray-50', 'border-transparent');
                activeClient = newClientId;
                console.log(`å·²åˆ‡æ›è‡³å®¢æˆ¶: ${newClientId}`);
                
                // æ¨¡æ“¬ç‹€æ…‹åˆå§‹åŒ–: é è¨­ç‚ºå°è©±ä¸­ (ä¸å½ˆå‡ºæç¤º)ï¼Œä½†æ§åˆ¶æ¬Šç‚ºå…¶ä»–éƒ¨é–€
                toggleConversationStatus(false, true); 
                releaseControl(true); // æ¨¡æ“¬åˆ‡æ›åˆ°å…¶ä»–å®¢æˆ¶æ™‚ï¼Œè¼¸å…¥æ¬Šé‡‹æ”¾çµ¦å…¶ä»–äºº
            }
        }

        /**
         * çµæŸæˆ–é‡æ–°é–‹å•Ÿç•¶å‰å°è©±ï¼Œåƒ…æ›´æ–°ç‹€æ…‹æ¨™è¨˜ (ä¸ç¦ç”¨è¼¸å…¥)
         * @param {boolean} isClosing - true è¡¨ç¤ºçµæŸ, false è¡¨ç¤ºé‡æ–°é–‹å•Ÿ
         * @param {boolean} isInit - true è¡¨ç¤ºåˆå§‹åŒ–ï¼Œä¸å½ˆå‡ºæç¤º
         */
        function toggleConversationStatus(isClosing, isInit = false) {
            isConversationClosed = isClosing;
            
            if (isClosing) {
                // çµæŸæ“ä½œ
                closeBtn.classList.add('hidden');
                openBtn.classList.remove('hidden');
                
                // è¦–è¦ºæç¤º
                crmStatusIndicator.textContent = 'ç‹€æ…‹: å·²çµæŸ';
                crmStatusIndicator.classList.remove('text-green-600');
                crmStatusIndicator.classList.add('text-blue-600');
                
                chatStatusVisual.textContent = 'å·²çµæŸ';
                chatStatusVisual.classList.remove('bg-green-100', 'text-green-600');
                chatStatusVisual.classList.add('bg-blue-100', 'text-blue-600');

                if (!isInit) {
                    // æ¨¡æ“¬æ›´æ–° CRM åå–®ç‹€æ…‹ç‚ºå·²æˆäº¤
                    if (listStatusSelect.value !== 'WON') {
                         listStatusSelect.value = 'WON'; 
                    }
                    alertCustom("å°è©±ç‹€æ…‹å·²æ¨™è¨˜ç‚ºã€å·²çµæŸã€‘ã€‚å…¶ä»–éƒ¨é–€å¯æŸ¥é–±ä¸¦é‡æ–°é–‹å•Ÿã€‚");
                    releaseControl(true); // çµæŸå°è©±å¾Œå¼·åˆ¶é‡‹æ”¾æ§åˆ¶æ¬Š
                }
            } else {
                // é‡æ–°é–‹å•Ÿæ“ä½œ
                closeBtn.classList.remove('hidden');
                openBtn.classList.add('hidden');
                
                // è¦–è¦ºæç¤º
                crmStatusIndicator.textContent = 'ç‹€æ…‹: é€²è¡Œä¸­';
                crmStatusIndicator.classList.remove('text-blue-600');
                crmStatusIndicator.classList.add('text-green-600');

                chatStatusVisual.textContent = 'å°è©±ä¸­';
                chatStatusVisual.classList.remove('bg-blue-100', 'text-blue-600');
                chatStatusVisual.classList.add('bg-green-100', 'text-green-600');
                
                if (!isInit) {
                    alertCustom("å°è©±ç‹€æ…‹å·²æ¨™è¨˜ç‚ºã€é€²è¡Œä¸­ã€‘ã€‚");
                }
            }
        }
        
        // --- æ–°å¢ï¼šå°è©±æ§åˆ¶æ¬ŠåŠŸèƒ½ ---

        // å–å¾—è¼¸å…¥æ§åˆ¶æ¬Š (è®Šç‚ºã€Œæ‚¨ã€å¯ä»¥è¼¸å…¥)
        function takeControl() {
            isCurrentDeptActive = true;
            
            // å•Ÿç”¨è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•
            chatInput.disabled = false;
            sendButton.disabled = false;
            
            // ç§»é™¤ç¦ç”¨æ¨£å¼
            chatInput.classList.remove('input-disabled-custom');
            sendButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            sendButton.classList.add('bg-teal-600', 'hover:bg-teal-700');
            
            // æ›´æ–° Placeholder
            chatInput.placeholder = "è¼¸å…¥æ‚¨çš„è¨Šæ¯...";

            // æ›´æ–°æ§åˆ¶æ¬Šé¡¯ç¤º
            controlStatus.textContent = 'ç›®å‰ç‹€æ…‹: æ‚¨æ­£åœ¨è¼¸å…¥ä¸­';
            controlStatus.classList.remove('text-red-500');
            controlStatus.classList.add('text-purple-600');
            
            // åˆ‡æ›æŒ‰éˆ•
            takeControlBtn.classList.add('hidden');
            releaseControlBtn.classList.remove('hidden');

            alertCustom("å·²å–å¾—ç™¼è¨€æ¬Šï¼Œç¾åœ¨å¯ä»¥èˆ‡å®¢æˆ¶æºé€šã€‚");
        }

        /**
         * é‡‹æ”¾è¼¸å…¥æ§åˆ¶æ¬Š (è®Šç‚ºã€Œå…¶ä»–éƒ¨é–€ã€è¼¸å…¥ä¸­)
         * @param {boolean} isInit - true è¡¨ç¤ºåˆå§‹åŒ–æˆ–å¼·åˆ¶é‡‹æ”¾ï¼Œä¸å½ˆå‡ºæç¤º
         */
        function releaseControl(isInit = false) {
            isCurrentDeptActive = false;

            // ç¦ç”¨è¼¸å…¥æ¡†å’ŒæŒ‰éˆ• (æ¨¡æ“¬å…¶ä»–éƒ¨é–€æ­£åœ¨ä½¿ç”¨)
            chatInput.disabled = true;
            sendButton.disabled = true;

            // æ–°å¢ç¦ç”¨æ¨£å¼
            chatInput.classList.add('input-disabled-custom');
            sendButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            sendButton.classList.remove('bg-teal-600', 'hover:bg-teal-700');
            
            // æ›´æ–° Placeholder
            chatInput.placeholder = "å®¢æœ æ™ºå¯¶ è¼¸å…¥è¨Šæ¯ä¸­";

            // æ›´æ–°æ§åˆ¶æ¬Šé¡¯ç¤º
            controlStatus.textContent = 'ç›®å‰ç‹€æ…‹: å®¢æœ æ™ºå¯¶ è¼¸å…¥ä¸­...';
            controlStatus.classList.remove('text-purple-600');
            controlStatus.classList.add('text-red-500');

            // åˆ‡æ›æŒ‰éˆ•
            takeControlBtn.classList.remove('hidden');
            releaseControlBtn.classList.add('hidden');
            
            if (!isInit) {
                alertCustom("å·²é‡‹æ”¾ç™¼è¨€æ¬Šï¼Œå…¶ä»–éƒ¨é–€å¯ä»¥æ¥æ‰‹æˆ–ç¹¼çºŒè¼¸å…¥ã€‚");
            }
        }


        // æ¨¡æ“¬ç™¼é€è¨Šæ¯
        function sendMessage() {
            const message = chatInput.value.trim();
            if (message === "") return;
            
            // æª¢æŸ¥æ˜¯å¦æ“æœ‰æ§åˆ¶æ¬Š
            if (!isCurrentDeptActive) {
                alertCustom("ç›®å‰ç™¼è¨€æ¬Šå±¬æ–¼å…¶ä»–éƒ¨é–€ã€‚è«‹å…ˆé»æ“Šã€ğŸ’¡ å–å¾—ç™¼è¨€æ¬Š (æ¥æ‰‹)ã€‘ã€‚");
                return;
            }
            
            // å‰µå»ºæ–°çš„è¨Šæ¯æ°£æ³¡ (å°ˆå“¡/å³å´)
            const newMessageHtml = `
                <div class="flex justify-end">
                    <div class="max-w-xs md:max-w-md bg-[#D4F8C8] p-3 rounded-t-xl rounded-bl-xl shadow-md border border-green-200">
                        <p class="text-gray-800">${message}</p>
                        <span class="block text-xs text-gray-500 mt-1 text-right">${new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })} âœ“âœ“</span>
                    </div>
                </div>
            `;

            chatMessages.insertAdjacentHTML('beforeend', newMessageHtml);
            chatInput.value = '';
            // æ²å‹•åˆ°æœ€åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // æ¨¡æ“¬å®¢æˆ¶å›æ‡‰ (å¯ä»¥å¿½ç•¥ï¼Œå–®ç´”è®“ä»‹é¢çœ‹èµ·ä¾†æ›´ç”Ÿå‹•)
            setTimeout(() => {
                receiveMessage("æ„Ÿè¬æ‚¨çš„å›è¦†ï¼Œæˆ‘éœ€è¦è€ƒæ…®ä¸€ä¸‹åƒ¹æ ¼ã€‚");
            }, 1500);
        }

        // æ¨¡æ“¬æ¥æ”¶è¨Šæ¯ (å®¢æˆ¶/å·¦å´)
        function receiveMessage(message) {
            const newMessageHtml = `
                <div class="flex justify-start">
                    <div class="max-w-xs md:max-w-md bg-white p-3 rounded-t-xl rounded-br-xl shadow-md border border-gray-200">
                        <p class="text-gray-700">${message}</p>
                        <span class="block text-xs text-gray-400 mt-1 text-right">${new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                </div>
            `;
            chatMessages.insertAdjacentHTML('beforeend', newMessageHtml);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }


        // æ¨¡æ“¬ä¸»ç®¡æŒ‡æ´¾å®¢æˆ¶ (æ´¾ç™¼å€åŠŸèƒ½)
        function assignClient() {
            const client = document.getElementById('client-select').value;
            const agent = document.getElementById('agent-select').value;

            if (!client || !agent) {
                alertCustom("è«‹å…ˆé¸å–å®¢æˆ¶åå–®èˆ‡æŒ‡æ´¾å°ˆå“¡ã€‚");
                return;
            }

            alertCustom(`æˆåŠŸï¼å·²å°‡å®¢æˆ¶ ${client} æŒ‡æ´¾çµ¦ ${agent}ï¼Œä¸¦å•Ÿå‹•å°è©±ã€‚`);
            toggleConversationStatus(false, true); // æ¨¡æ“¬æŒ‡æ´¾å¾Œç‹€æ…‹ç‚ºé–‹å•Ÿ
            takeControl(); // æ¨¡æ“¬æŒ‡æ´¾å¾Œç”±è‡ªå·±é–‹å§‹è¼¸å…¥
        }

        // æ¨¡æ“¬å„²å­˜ CRM æ¬„ä½
        function updateCrmFields() {
            const listStatus = document.getElementById('list-status').value;
            const followupTime = document.getElementById('followup-time').value;

            console.log(`å„²å­˜ CRM è®Šå‹•: 
                åå–®ç‹€æ…‹: ${listStatus}, 
                ä¸‹æ¬¡è¿½è¹¤: ${followupTime}
            `);
            
            alertCustom("CRM æ¬„ä½æ›´æ–°æˆåŠŸï¼å·²å„²å­˜åå–®ç‹€æ…‹èˆ‡è¿½è¹¤æ’ç¨‹ã€‚");
        }


        // è‡ªå®šç¾©ç°¡æ˜“è¨Šæ¯å½ˆçª—å–ä»£ alert()
        function alertCustom(message) {
            let existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = 'fixed top-4 right-4 bg-teal-600 text-white p-4 rounded-xl shadow-2xl z-50 transition-all duration-300 transform scale-0 opacity-0'; 
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            // é¡¯ç¤ºå½ˆçª—
            setTimeout(() => {
                alertDiv.classList.add('scale-100', 'opacity-100');
                alertDiv.classList.remove('scale-0');
            }, 10);

            // 3 ç§’å¾Œéš±è—ä¸¦ç§»é™¤
            setTimeout(() => {
                alertDiv.classList.remove('scale-100', 'opacity-100');
                alertDiv.classList.add('scale-0', 'opacity-0');
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }

    </script>
</body>
</html>
