<!-- Chosen Palette: Indigo/Green Minimalist -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šç¶²å¤§é›™ç¶²å®¢æˆ¶å·¥é …è‡ªå‹•åŒ–ä»‹é¢ V2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styling for Inter font and chart container control */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
        font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3ff6;
        }
        /* Custom styling for inputs */
        .form-select {
            transition: all 0.15s ease-in-out;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke='%234B5563' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3csvg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .form-select:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }
        /* Adjusted font size for primary output text */
        .primary-output-text {
            font-size: 1.125rem; /* Slightly smaller for multiple lines */
            font-weight: 700;
            color: #4338CA; /* Indigo 700 */
            /* Ensure each line starts on a new line */
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <!-- Main Content Container -->
    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- Header Section -->
        <header class="p-6 bg-indigo-700 text-white flex flex-col sm:flex-row justify-between items-start sm:items-center rounded-t-xl">
            <h1 class="text-2xl font-bold tracking-tight mb-2 sm:mb-0">ä»Šç¶²å¤§é›™ç¶²å®¢æˆ¶å·¥é …è‡ªå‹•åŒ–ä»‹é¢ V2.2</h1>
            <span class="text-sm opacity-80 font-medium bg-indigo-800 px-3 py-1 rounded-full">å·¥é …é‚è¼¯é©—è­‰èˆ‡è¼¸å‡º</span>
        </header>

        <div class="p-6 sm:p-8 lg:flex lg:space-x-8 lg:items-stretch">
            
            <!-- 1. Form Section å¡«å¯«å€ (Input Area) -->
            <div class="lg:w-3/5 space-y-6">
                <h2 class="text-xl font-semibold mb-6 pb-2 border-b border-gray-200 text-indigo-800 flex items-center">
                    <span class="mr-2">ğŸ“</span>
                    å®¢æˆ¶æƒ…å¢ƒè¨­å®šå€ (å³æ™‚é‹ç®—å·¥é …)
                </h2>

                <form id="workOrderForm" class="space-y-6">
                    
                    <!-- å€å¡Šä¸€ï¼šæ–¹æ¡ˆè³‡è¨Š (ç”¨æ–¼æ¨™é¡Œæˆ–å‚™è¨») -->
                    <div class="p-4 bg-indigo-50/50 rounded-xl border border-indigo-300 shadow-sm">
                        <h3 class="text-lg font-bold mb-4 text-indigo-700 flex items-center">
                            <span class="mr-2 text-xl">â¶</span>
                            å€å¡Šä¸€ï¼šæ–¹æ¡ˆé€Ÿè¨˜ (å³æ™‚è¨ˆç®—)
                        </h3>
                        
                        <!-- å¤šé–€è™Ÿæ§åˆ¶é … -->
                        <div class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-6 mb-4 pb-4 border-b border-indigo-200">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="multipleLinesCheckbox" class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                <label for="multipleLinesCheckbox" class="font-bold text-indigo-700">å¤šå€‹é–€è™Ÿ</label>
                            </div>
                            
                            <div class="space-y-1" id="lineCountWrapper">
                                <label for="lineCountSelect" class="block text-sm font-medium text-gray-700">ç¸½é–€è™Ÿæ•¸</label>
                                <select id="lineCountSelect" class="form-select rounded-lg border border-gray-300 shadow-sm p-2 w-20" disabled>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        </div>

                        <!-- Dynamic Line Containers -->
                        <div id="dynamicPhoneLinesContainer" class="space-y-6">
                            <!-- Lines will be rendered here by JS -->
                        </div>
                    </div>

                    <!-- å€å¡ŠäºŒï¼šç´°ç¯€èˆ‡å·¥é …ä¾æ“š (å‰©ä¸‹æ¬„ä½) -->
                    <div class="p-4 bg-gray-50 rounded-xl border border-gray-300 shadow-sm">
                        <h3 class="text-lg font-bold mb-4 text-gray-700 flex items-center">
                            <span class="mr-2 text-xl">â·</span>
                            å€å¡ŠäºŒï¼šå·¥é …è¨ˆç®—ç´°ç¯€ (åƒ…åƒè€ƒç¬¬ä¸€å€‹é–€è™Ÿæƒ…å¢ƒ)
                        </h3>
                        <!-- Input Grid for Block 2 (now only 4 fields) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                            <!-- ä»Šç¶²ç¶²è·¯ (Select) -->
                            <div class="space-y-1">
                                <label for="jingnetStatus" class="block text-sm font-medium text-gray-700">ä»Šç¶²ç¶²è·¯ <span class="text-red-500">*</span></label>
                                <select id="jingnetStatus" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="" selected>è«‹é¸æ“‡</option>
                                    <option value="æ–°è£æ©Ÿå·²ä»˜æ¬¾">æ–°è£æ©Ÿå·²ä»˜æ¬¾</option>
                                    <option value="æ–°è£æ©Ÿæœªä»˜æ¬¾">æ–°è£æ©Ÿæœªä»˜æ¬¾</option>
                                    <option value="æœŸä¸­å®¢">æœŸä¸­å®¢</option>
                                    <option value="çºŒç´„å®¢å·²ä»˜æ¬¾">çºŒç´„å®¢å·²ä»˜æ¬¾</option>
                                    <option value="çºŒç´„å®¢æœªä»˜æ¬¾">çºŒç´„å®¢æœªä»˜æ¬¾</option>
                                </select>
                            </div>

                            <!-- åŸé›»ä¿¡åˆç´„ (Select) -->
                            <div class="space-y-1">
                                <label for="originalContract" class="block text-sm font-medium text-gray-700">åŸé›»ä¿¡åˆç´„ <span class="text-red-500">*</span></label>
                                <select id="originalContract" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="" selected>è«‹é¸æ“‡</option>
                                    <option value="é ˆè§£ç´„">é ˆè§£ç´„</option>
                                    <option value="ç„¡åˆç´„">ç„¡åˆç´„</option>
                                    <option value="28å¤©å…§">28å¤©å…§</option>
                                    <option value="ç„¡">ç„¡</option> <!-- æ–°å¢é¸é … -->
                                </select>
                            </div>
                            
                            <!-- æ¬¾é … (Select) -->
                            <div class="space-y-1">
                                <label for="paymentType" class="block text-sm font-medium text-gray-700">æ¬¾é … <span class="text-red-500">*</span></label>
                                <select id="paymentType" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="" selected>è«‹é¸æ“‡</option> 
                                    <option value="é ç¹³é‡‘">é ç¹³é‡‘</option>
                                    <option value="ç„¡">ç„¡</option>
                                </select>
                            </div>
                            
                            <!-- SIMå¡ (Select) -->
                            <div class="space-y-1">
                                <label for="simDelivery" class="block text-sm font-medium text-gray-700">SIMå¡æ´¾é€æ–¹å¼ <span class="text-red-500">*</span></label>
                                <select id="simDelivery" class="form-select w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="" selected>è«‹é¸æ“‡</option>
                                    <!-- Options populated by JS dynamically based on telecom provider -->
                                </select>
                            </div>
                            
                        </div>

                        <!-- å…¶ä»–å·¥é …(è«‹èªªæ˜) -->
                        <div class="space-y-1 pt-6">
                            <label for="otherTaskDescription" class="block text-sm font-medium text-gray-700">å…¶ä»–å·¥é …èªªæ˜ (è‹¥æœ‰å‰‡æœƒè‡ªå‹•åŠ å…¥æ¸…å–®)</label>
                            <textarea id="otherTaskDescription" rows="2" placeholder="è«‹è¼¸å…¥éœ€è¦æ‰‹å‹•è¿½è¹¤æˆ–ç‰¹æ®Šè™•ç†çš„ä»»å‹™èªªæ˜" class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
                        </div>
                    </div>

                </form>
            </div>

            <!-- 2. Output Section å·¥é …å€ (Result Area) -->
            <div class="lg:w-2/5 mt-8 lg:mt-0 space-y-8">
                
                <!-- === Primary Output (å€å¡Šä¸€çµæœ) === -->
                <div class="p-0">
                    <h2 class="text-xl font-semibold mb-4 pb-2 border-b border-indigo-200 text-indigo-700 flex items-center">
                        <span class="mr-2">ğŸ’¡</span>
                        å€å¡Šä¸€ï¼šæ–¹æ¡ˆé€Ÿè¨˜ (å¿«é€Ÿè¤‡è£½ç”¨)
                    </h2>
                    
                    <div id="primaryOutput" class="p-4 border-2 border-indigo-500 rounded-xl bg-indigo-50 min-h-16 shadow-inner transition duration-300 flex items-center justify-center">
                        <p class="text-gray-500 italic">è«‹åœ¨å·¦å´å¡«å¯«å€å¡Šä¸€è³‡è¨Š</p>
                    </div>
                    
                    <button id="copyPrimaryButton" class="mt-4 w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.005] flex items-center justify-center">
                        <span class="mr-2">ğŸ“‹</span>
                        è¤‡è£½æ–¹æ¡ˆé€Ÿè¨˜
                    </button>
                </div>


                <!-- === Secondary Output (å€å¡ŠäºŒçµæœ/å·¥é …æ¸…å–®) -->
                <div class="p-0">
                    <h2 class="text-xl font-semibold mb-4 pb-2 border-b border-gray-200 text-green-700 flex items-center">
                        <span class="mr-2">âœ…</span>
                        å€å¡ŠäºŒï¼šè‡ªå‹•ç”¢å‡ºå·¥é …æ¸…å–®
                    </h2>
                    
                    <!-- Work Items Output -->
                    <div id="workItemsOutput" class="space-y-4 p-4 border-2 border-green-300 rounded-xl bg-green-50 min-h-64 shadow-inner transition duration-300">
                        <p class="text-gray-500 italic text-center pt-8">è«‹åœ¨å·¦å´å®Œæ•´å¡«å¯«æ‰€æœ‰å®¢æˆ¶è³‡è¨Šï¼Œå·¥é …æœƒå³æ™‚è‡ªå‹•ç”Ÿæˆã€‚</p>
                    </div>
                    
                    <!-- Red Warning for Chunghwa Mid-Term -->
                    <div id="chunghwaMidTermWarning" class="hidden mt-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 font-semibold rounded-lg text-sm shadow-md">
                        <!-- æé†’èªå°‡ç”± JavaScript è¼‰å…¥ -->
                    </div>

                    <!-- Action Button & Confirmation -->
                    <button id="copyWorkItemsButton" class="mt-6 w-full py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.005] flex items-center justify-center">
                        <span class="mr-2">ğŸ“</span>
                        è¤‡è£½å·¥é …æ¸…å–®
                    </button>
                </div>
                
                <div id="confirmationMessage" class="hidden mt-4 p-3 text-center rounded-lg font-medium shadow-md">
                    <!-- Confirmation message will appear here -->
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('workOrderForm');
            
            // Output elements for Primary Section (Block 1)
            const primaryOutputDiv = document.getElementById('primaryOutput');
            const copyPrimaryButton = document.getElementById('copyPrimaryButton');

            // Output elements for Secondary Section (Block 2)
            const workItemsOutputDiv = document.getElementById('workItemsOutput');
            const copyWorkItemsButton = document.getElementById('copyWorkItemsButton');
            
            const confirmationMessage = document.getElementById('confirmationMessage');
            const chunghwaMidTermWarning = document.getElementById('chunghwaMidTermWarning');
            
            // New Multi-line elements
            const multipleLinesCheckbox = document.getElementById('multipleLinesCheckbox');
            const lineCountSelect = document.getElementById('lineCountSelect');
            const dynamicPhoneLinesContainer = document.getElementById('dynamicPhoneLinesContainer');
            
            // Block 2 Select elements (still global/single)
            const originalContractSelect = document.getElementById('originalContract'); // åŸé›»ä¿¡åˆç´„
            const simDeliverySelect = document.getElementById('simDelivery'); 
            const paymentTypeSelect = document.getElementById('paymentType'); // æ¬¾é …

            // å®šç¾©æ‰€æœ‰è³‡è²»é¸é … (æ¨™æº–é¸é …é›†)
            const allFees = ["399", "599", "699", "799", "999", "1399"];

            // å®šç¾©é›»ä¿¡æ¥­è€… (æ¨™æº–é¸é …é›†)
            const defaultProviders = ["ä¸­è¯", "é å‚³"];

            // å®šç¾©æ‰€æœ‰ SIM å¡æ´¾é€é¸é …
            const allSimDeliveryOptions = [
                { value: "è¦ªé€", label: "è¦ªé€" },
                { value: "å¯„å¡", label: "å¯„å¡" },
                { value: "é€å¡", label: "é€å¡" },
                { value: "è‡³å…¬å¸å–å¡", label: "è‡³å…¬å¸å–å¡" },
                { value: "eSIM", label: "eSIM" },
                { value: "å°ä¸­å–å¡", label: "å°ä¸­å–å¡" },
                { value: "ç„¡é ˆæ´¾é€", label: "ç„¡é ˆæ´¾é€" },
            ];
            
            // å®šç¾©æ‰€æœ‰ç¶²è·¯æœˆä»½é¸é … (ä¸€èˆ¬æƒ…å¢ƒ) - **å¾®èª¿é †åºèˆ‡æ–°å¢é¸é …**
            const defaultInternetMonths = [
                "12+2", 
                "14+2", 
                "24+1", 
                "24+2", 
                "24+3", 
                "24+4", 
                "3", "4", "8", "9", "13", "16", "19", 
                "24", 
                "30",
                "30+4", // æ–°å¢: æ”¾åœ¨ 30 çš„ä¸‹æ–¹
            ];

            // çºŒç´„ä¸­è¯å°ˆå±¬é¸é …
            const renewalChunghwaMonths = [
                "3", "5", "8", "9", "14", "21", 
                "24", "24+2", "24+4"
            ];
            
            // ä¸»æ¥­æ¬Šè´ˆé€æ‰€éœ€æœˆä»½
            const requiredGiftMonths = ["24+1", "24+2", "24+3", "24+4", "12+2", "14+2", "30+4"]; // é›–ç„¶æ²’èªªè¦åŠ ï¼Œä½†é€šå¸¸å¸¶+è™Ÿçš„éƒ½å±¬æ–¼ä¸»æ¥­æ¬Šè´ˆé€ï¼Œè‹¥ä¸ç¢ºå®šå¯ç¶­æŒåŸæ¨£ã€‚


            /**
             * å–å¾—å–®ä¸€é–€è™Ÿæ¬„ä½çš„ HTML æ¨¡æ¿ã€‚
             */
            function getPhoneLineTemplate(index) {
                const title = index === 0 ? 'é–€è™Ÿæƒ…å¢ƒè¨­å®š' : `é–€è™Ÿ ${index + 1} æƒ…å¢ƒè¨­å®š`;
                return `
                    <div class="phone-line-form p-4 bg-white rounded-lg border border-gray-200 shadow-sm" data-line-index="${index}">
                        <h4 class="text-md font-semibold mb-3 text-indigo-600 border-b border-indigo-100 pb-2">${title}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            
                            <!-- æ–¹æ¡ˆç‹€æ…‹ (Select) -->
                            <div class="space-y-1">
                                <label class="block text-sm font-medium text-gray-700">æ–¹æ¡ˆç‹€æ…‹ <span class="text-red-500">*</span></label>
                                <select class="line-input plan-status-select form-select w-full rounded-lg border border-gray-300 shadow-sm p-2">
                                    <option value="" selected>è«‹é¸æ“‡</option>
                                    <option value="æ–°è¾¦">æ–°è¾¦</option>
                                    <option value="æ”œç¢¼">æ”œç¢¼</option>
                                    <option value="çºŒç´„">çºŒç´„</option>
                                </select>
                            </div>

                            <!-- ç”³è¾¦é›»ä¿¡ (Select) -->
                            <div class="space-y-1">
                                <label class="block text-sm font-medium text-gray-700">ç”³è¾¦é›»ä¿¡ <span class="text-red-500">*</span></label>
                                <select class="line-input telecom-provider-select form-select w-full rounded-lg border border-gray-300 shadow-sm p-2">
                                    <option value="" selected>è«‹é¸æ“‡</option>
                                </select>
                            </div>
                            
                            <!-- æœˆè³‡è²» (Select) -->
                            <div class="space-y-1">
                                <label class="block text-sm font-medium text-gray-700">æœˆè³‡è²» <span class="text-red-500">*</span></label>
                                <select class="line-input monthly-fee-select form-select w-full rounded-lg border border-gray-300 shadow-sm p-2">
                                    <option value="" selected>è«‹é¸æ“‡</option>
                                </select>
                            </div>

                            <!-- ç¶²è·¯æœˆä»½ (Select) -->
                            <div class="space-y-1">
                                <label class="block text-sm font-medium text-gray-700">ç¶²è·¯æœˆä»½ <span class="text-red-500">*</span></label>
                                <select class="line-input internet-months-select form-select w-full rounded-lg border border-gray-300 shadow-sm p-2">
                                    <option value="" selected>è«‹é¸æ“‡</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }

            /**
             * æ›´æ–°ç‰¹å®šé–€è™Ÿçš„ç”³è¾¦é›»ä¿¡é¸é …ã€‚
             */
            function updateTelecomProviderOptions(selectElement) {
                const currentProvider = selectElement.value;
                selectElement.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

                defaultProviders.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider;
                    option.textContent = provider;
                    selectElement.appendChild(option);
                });

                if (defaultProviders.includes(currentProvider)) {
                    selectElement.value = currentProvider;
                } else {
                    selectElement.value = "";
                }
            }
            
            /**
             * æ ¹æ“šç”³è¾¦é›»ä¿¡ï¼Œæ›´æ–°ç‰¹å®šé–€è™Ÿçš„æœˆè³‡è²»é¸é …ã€‚
             */
            function updateMonthlyFeeOptions(selectElement, selectedProvider) {
                const currentFee = selectElement.value;
                selectElement.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

                if (!selectedProvider) return;

                let feesToShow = [...allFees];
                
                // æ ¹æ“šé›»ä¿¡ç¯©é¸ 
                if (selectedProvider === 'ä¸­è¯') {
                    // ä¸­è¯æ¨™æº–æ–¹æ¡ˆä¸æä¾› 399
                    feesToShow = feesToShow.filter(fee => fee !== "399");
                } else if (selectedProvider === 'é å‚³') {
                    // é å‚³æ¨™æº–æ–¹æ¡ˆä¸æä¾› 699
                    feesToShow = feesToShow.filter(fee => fee !== "699");
                }

                feesToShow.forEach(fee => {
                    const option = document.createElement('option');
                    option.value = fee;
                    option.textContent = fee;
                    selectElement.appendChild(option);
                });

                if (feesToShow.includes(currentFee)) {
                    selectElement.value = currentFee;
                } else {
                    selectElement.value = ""; 
                }
            }
            
            /**
             * æ ¹æ“šæ–¹æ¡ˆç‹€æ…‹å’Œç”³è¾¦é›»ä¿¡ï¼Œæ›´æ–°ç‰¹å®šé–€è™Ÿçš„ç¶²è·¯æœˆä»½é¸é …ã€‚
             */
            function updateInternetMonthsOptions(selectElement, planStatus, telecomProvider) {
                const currentMonths = selectElement.value;
                selectElement.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

                if (!planStatus || !telecomProvider) return;

                let monthsToShow;

                if (planStatus === 'çºŒç´„' && telecomProvider === 'ä¸­è¯') {
                    // çºŒç´„ä¸­è¯å°ˆå±¬æœˆä»½
                    monthsToShow = [...renewalChunghwaMonths];
                } else {
                    // ä¸€èˆ¬æƒ…å¢ƒæœˆä»½
                    monthsToShow = [...defaultInternetMonths];
                }
                
                // æ ¹æ“šè¦æ±‚ï¼Œå¦‚æœç‹€æ…‹æ˜¯çºŒç´„ï¼Œå‰‡æ’é™¤ 12+2 å’Œ 14+2
                if (planStatus === 'çºŒç´„') {
                    monthsToShow = monthsToShow.filter(month => month !== "12+2" && month !== "14+2");
                }


                monthsToShow.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month;
                    selectElement.appendChild(option);
                });

                if (monthsToShow.includes(currentMonths)) {
                    selectElement.value = currentMonths;
                } else {
                    selectElement.value = ""; 
                }
            }

            /**
             * è™•ç†å–®ä¸€é–€è™Ÿæ¬„ä½çš„äº‹ä»¶ç›£è½å’Œå‹•æ…‹é¸é …æ›´æ–°ã€‚
             * @param {HTMLElement} lineContainer - è©²é–€è™Ÿçš„çˆ¶å®¹å™¨ element.
             */
            function setupLineEventListeners(lineContainer) {
                const statusSelect = lineContainer.querySelector('.plan-status-select');
                const providerSelect = lineContainer.querySelector('.telecom-provider-select');
                const feeSelect = lineContainer.querySelector('.monthly-fee-select');
                const monthsSelect = lineContainer.querySelector('.internet-months-select');

                // åˆå§‹è¼‰å…¥æ™‚ï¼Œå…ˆæ›´æ–°é¸é …æ¸…å–® (å› ç‚ºæ¨¡æ¿ä¸­é¸é …æ˜¯ç©ºçš„)
                updateTelecomProviderOptions(providerSelect); 
                updateMonthlyFeeOptions(feeSelect, providerSelect.value);
                updateInternetMonthsOptions(monthsSelect, statusSelect.value, providerSelect.value);

                // ç›£è½æ‰€æœ‰ Select è®Šå‹•ï¼Œé‡æ–°è¨ˆç®—å·¥é …
                lineContainer.querySelectorAll('.line-input').forEach(input => {
                    input.addEventListener('change', calculateWorkItems);
                });

                // ç›£è½ç‹€æ…‹æˆ–é›»ä¿¡è®Šå‹•ï¼Œæ›´æ–°è³‡è²»/æœˆä»½çš„é¸é …
                [statusSelect, providerSelect].forEach(input => {
                    input.addEventListener('change', () => {
                        const currentStatus = statusSelect.value;
                        const currentProvider = providerSelect.value;
                        
                        // å‹•æ…‹æ›´æ–°è³‡è²»å’Œæœˆä»½çš„é¸é …
                        updateMonthlyFeeOptions(feeSelect, currentProvider);
                        updateInternetMonthsOptions(monthsSelect, currentStatus, currentProvider);

                        // é‡æ–°è¨ˆç®—å·¥é …
                        calculateWorkItems();
                    });
                });
            }

            /**
             * æ ¹æ“šé¸æ“‡çš„é–€è™Ÿæ•¸é‡ï¼Œå‹•æ…‹ç”Ÿæˆä¸¦æ¸²æŸ“è¼¸å…¥æ¬„ä½ã€‚
             */
            function renderPhoneLines(count) {
                dynamicPhoneLinesContainer.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const templateHtml = getPhoneLineTemplate(i);
                    const lineDiv = document.createElement('div');
                    lineDiv.innerHTML = templateHtml.trim();
                    dynamicPhoneLinesContainer.appendChild(lineDiv.firstChild);

                    // é‡å°æ–°ç”Ÿæˆçš„é–€è™Ÿæ¬„ä½è¨­å®šäº‹ä»¶ç›£è½
                    setupLineEventListeners(dynamicPhoneLinesContainer.children[i]);
                }
            }
            
            /**
             * å¾æ‰€æœ‰å‹•æ…‹ç”Ÿæˆçš„é–€è™Ÿæ¬„ä½ä¸­æ”¶é›†æ•¸æ“šã€‚
             * @returns {Array<{planStatus: string, telecomProvider: string, monthlyFee: string, internetMonths: string}>}
             */
            function collectLineData() {
                const linesData = [];
                const lineContainers = dynamicPhoneLinesContainer.querySelectorAll('.phone-line-form');
                
                lineContainers.forEach(container => {
                    const data = {
                        planStatus: container.querySelector('.plan-status-select').value,
                        telecomProvider: container.querySelector('.telecom-provider-select').value,
                        monthlyFee: container.querySelector('.monthly-fee-select').value,
                        internetMonths: container.querySelector('.internet-months-select').value,
                    };
                    linesData.push(data);
                });

                return linesData;
            }
            
            /**
             * è™•ç†ã€ŒçºŒç´„ä¸­è¯ã€æƒ…å¢ƒä¸‹çš„ Block 2 é è¨­å€¼è¨­å®šã€‚
             * åƒ…ç•¶ç¬¬ä¸€å€‹é–€è™Ÿé¸æ“‡ã€ŒçºŒç´„ä¸­è¯ã€æ™‚è§¸ç™¼ã€‚
             */
            function handleRenewalChunghwaDefaults(firstLineData) {
                if (!firstLineData) return;

                const { planStatus, telecomProvider } = firstLineData;
                
                // æª¢æŸ¥æ˜¯å¦ç‚º çºŒç´„ä¸­è¯
                if (planStatus === 'çºŒç´„' && telecomProvider === 'ä¸­è¯') {
                    // å¸¶å…¥çºŒç´„ä¸­è¯çš„é è¨­å€¼ (Block 2)
                    originalContractSelect.value = 'ç„¡';
                    simDeliverySelect.value = 'ç„¡é ˆæ´¾é€'; 
                }
                // å¦å‰‡ä¸åšä»»ä½•æ“ä½œï¼Œè®“ç”¨æˆ¶æ‰‹å‹•é¸æ“‡ Block 2
            }


            /**
             * æ ¹æ“šç”³è¾¦é›»ä¿¡ï¼Œå‹•æ…‹æ›´æ–° SIM å¡æ´¾é€æ–¹å¼é¸é … (Block 2, å–®ä¸€)ã€‚
             */
            function updateSimDeliveryOptions(selectedProvider) {
                const currentSimDelivery = simDeliverySelect.value;
                simDeliverySelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

                if (!selectedProvider) {
                    allSimDeliveryOptions.forEach(optionDef => {
                        const option = document.createElement('option');
                        option.value = optionDef.value;
                        option.textContent = optionDef.label;
                        simDeliverySelect.appendChild(option);
                    });
                    return;
                }

                let allowedOptions = allSimDeliveryOptions;

                // æ¨™æº–é™åˆ¶
                if (selectedProvider === 'ä¸­è¯') {
                    // ä¸­è¯ä¸å…è¨±è¦ªé€ (æ¨™æº–é™åˆ¶)
                    allowedOptions = allowedOptions.filter(opt => opt.value !== "è¦ªé€");
                } else if (selectedProvider === 'é å‚³') {
                    // é å‚³ä¸å…è¨±è‡³å…¬å¸å–å¡, eSIM (æ¨™æº–é™åˆ¶)
                    allowedOptions = allowedOptions.filter(opt => opt.value !== "è‡³å…¬å¸å–å¡" && opt.value !== "eSIM");
                }
                
                allowedOptions.forEach(optionDef => {
                    const option = document.createElement('option');
                    option.value = optionDef.value;
                    option.textContent = optionDef.label;
                    simDeliverySelect.appendChild(option);
                });

                if (allowedOptions.some(opt => opt.value === currentSimDelivery)) {
                    simDeliverySelect.value = currentSimDelivery;
                } else {
                    simDeliverySelect.value = "";
                }
            }


            // å·¥é …é‚è¼¯å®šç¾© (Work Item Rules)
            const workItemRules = [
                // åŸºç¤å·¥é … 
                { name: "æ”¹æ–°è£æ©Ÿå·¥å–®", condition: (v) => v.jingnetStatus === "æ–°è£æ©Ÿæœªä»˜æ¬¾", category: "General" },
                { name: "é ç¹³é‡‘/åŒ¯æ¬¾è³‡æ–™æ ¸å°", condition: (v) => v.telecomProvider === "ä¸­è¯" && v.paymentType !== "ç„¡", category: "Finance" },
                { name: "ä¸­è¯ä¸ŠäºŒéš", condition: (v) => v.telecomProvider === "ä¸­è¯", category: "General" },
                { name: "é•ç´„å–®æ“šä¸Šå‚³ã€é€æœƒè¾¦", condition: (v) => v.originalContract === "é ˆè§£ç´„", category: "Contract" }, 
                
                // === ä¸»æ¥­æ¬Šè´ˆé€ - æ¢ä»¶ç¶­æŒä¸è®Š ===
                { 
                    name: "ä¸»æ¥­æ¬Šè´ˆé€", 
                    condition: (v) => (v.jingnetStatus.includes("æ–°è£æ©Ÿ") || v.jingnetStatus.includes("çºŒç´„å®¢")) && 
                                       requiredGiftMonths.includes(v.internetMonths), // ç¶­æŒç‰¹å®šæœˆä»½åˆ¤æ–·
                    category: "General" 
                },
                
                // é€€è²»èˆ‡çµå–®
                { name: "é€€è²»(è«‹ç¢ºèªå®¢æˆ¶å·²ç¹³è²»ã€å·²è£æ©Ÿï¼Œé‡‘é¡è«‹è²¼è¨˜äº‹æœ¬)", condition: (v) => v.jingnetStatus === "æ–°è£æ©Ÿå·²ä»˜æ¬¾" || v.jingnetStatus === "çºŒç´„å®¢å·²ä»˜æ¬¾", category: "Refund" },
                { name: "Chatâ”€çµå–®(æœƒè¨ˆ)(è«‹å…ˆç¢ºèªå®¢æˆ¶å·²ç¹³è²»ã€å·²è£æ©Ÿ)", condition: (v) => v.jingnetStatus.includes("çºŒç´„å®¢") || v.jingnetStatus.includes("æœŸä¸­å®¢"), category: "Settlement" },
                
                // === æ´¾é€èˆ‡ Chat é‚è¼¯ - ç¶­æŒä¸è®Š ===
                
                // 1. Chatâ”€å¯„é€ç¾¤: (ç¶­æŒèˆŠæœ‰æ¢ä»¶) OR (æ–°å¢: çºŒç´„ä¸­è¯ï¼Œå³ä½¿æ˜¯ç„¡é ˆæ´¾é€ä¹Ÿè¦è§¸ç™¼)
                { 
                    name: "Chatâ”€å¯„é€ç¾¤", 
                    condition: (v) => (v.planStatus === 'çºŒç´„' && v.telecomProvider === 'ä¸­è¯') || // çºŒç´„ä¸­è¯ï¼Œå¼·åˆ¶è§¸ç™¼
                                     ["å¯„å¡", "è¦ªé€", "eSIM"].includes(v.simDelivery) || 
                                     (v.telecomProvider === "é å‚³" && v.simDelivery === "å°ä¸­å–å¡"),
                    category: "Chat" 
                },
                
                // 2. Chat--ä¸­è¯æ‹ç…§ç¾¤: æ’é™¤çºŒç´„ä¸­è¯ (planStatus !== 'çºŒç´„')
                { 
                    name: "Chat--ä¸­è¯æ‹ç…§ç¾¤", 
                    condition: (v) => v.telecomProvider === "ä¸­è¯" && v.planStatus !== 'çºŒç´„', 
                    category: "Chat" 
                },
                
                // 3. Chatâ”€å…¨å€åŠ©ç†:
                { 
                    name: "Chatâ”€å…¨å€åŠ©ç†", 
                    condition: (v) => v.simDelivery === "é€å¡",
                    category: "Chat" 
                },
                
                // 4. æ´¾å¡ç¶²ç¶­å–®(ç„¡å·¥å–®):
                { 
                    name: "æ´¾å¡ç¶²ç¶­å–®(ç„¡å·¥å–®)", 
                    condition: (v) => v.simDelivery === "é€å¡" && 
                                     v.jingnetStatus !== "æ–°è£æ©Ÿæœªä»˜æ¬¾" && 
                                     !(v.telecomProvider === "ä¸­è¯" && v.jingnetStatus === "æœŸä¸­å®¢"), 
                    category: "Dispatch" 
                },

                // 5. é›»å•†æ´¾æ¡ˆ: æ ¹æ“šæ‚¨çš„è¦æ±‚ï¼Œæ”¹ç‚ºæ‰€æœ‰æƒ…å¢ƒåªè¦è¡¨å–®å¡«å®Œå°±æœƒå‡ºç¾
                { name: "é›»å•†æ´¾æ¡ˆ", condition: (v) => true, category: "Dispatch" }, 
            ];

            function calculateWorkItems() {
                // 1. å–å¾—æ‰€æœ‰é–€è™Ÿçš„è¼¸å…¥å€¼ (Block 1)
                const lineDataArray = collectLineData();
                const firstLineData = lineDataArray.length > 0 ? lineDataArray[0] : null;

                // æª¢æŸ¥ Block 1 æ˜¯å¦å…¨éƒ¨é¸å®Œ (æ‰€æœ‰é–€è™Ÿ)
                const isBlock1Complete = lineDataArray.length > 0 && lineDataArray.every(line => 
                    line.planStatus !== "" && line.telecomProvider !== "" && line.monthlyFee !== "" && line.internetMonths !== ""
                );
                
                // === Block 2 Dependencies & Defaults (Based on First Line) ===
                if (firstLineData) {
                    // A. æ ¹æ“šç¬¬ä¸€å€‹é–€è™Ÿçš„é›»ä¿¡æ›´æ–° SIM å¡é¸é … (Block 2)
                    updateSimDeliveryOptions(firstLineData.telecomProvider); 

                    // B. è™•ç†ã€ŒçºŒç´„ä¸­è¯ã€é è¨­å€¼
                    // çºŒç´„ä¸­è¯æœƒå¼·åˆ¶è¨­å®š originalContractSelect.value å’Œ simDeliverySelect.value ç‚ºã€Œç„¡ã€/ã€Œç„¡é ˆæ´¾é€ã€ã€‚
                    handleRenewalChunghwaDefaults(firstLineData);
                    
                    // C. è™•ç†ã€Œé å‚³ã€æ¬¾é …é è¨­å€¼
                    const isFarEasTone = firstLineData.telecomProvider === 'é å‚³';
                    if (isFarEasTone && paymentTypeSelect.value === '') {
                        paymentTypeSelect.value = 'ç„¡';
                    }
                    // å¦å‰‡ï¼Œè‹¥åˆ‡æ›å›ä¸­è¯ï¼Œæ¸…ç©ºé è¨­å€¼è®“ç”¨æˆ¶é¸æ“‡ (åƒ…åœ¨ä»Šç¶²ç‹€æ…‹æœªé¸æ™‚æ‰æ¸…ç©ºï¼Œé¿å…è¦†è“‹ç”¨æˆ¶é¸æ“‡)
                    else if (firstLineData.telecomProvider === 'ä¸­è¯' && paymentTypeSelect.value === 'ç„¡' && 
                             document.getElementById('jingnetStatus').value === '') { 
                        paymentTypeSelect.value = '';
                    }
                } else {
                    // è‹¥ç„¡é–€è™Ÿè³‡æ–™ï¼Œé‡ç½® SIM æ´¾é€é¸é …
                    updateSimDeliveryOptions("");
                }

                // === å€å¡Šä¸€è¼¸å‡ºé‚è¼¯ (Primary Output) ===
                if (isBlock1Complete) {
                    const primaryOutputText = lineDataArray.map(line => {
                        // è¼¸å‡ºæ ¼å¼: æ–¹æ¡ˆç‹€æ…‹ + é›»ä¿¡ + è³‡è²» / æœˆä»½
                        return `${line.planStatus}${line.telecomProvider}${line.monthlyFee}/${line.internetMonths}`;
                    }).join('\n'); // ä½¿ç”¨æ›è¡Œç¬¦è™Ÿåˆ†éš”
                    
                    primaryOutputDiv.innerHTML = `<span class="primary-output-text">${primaryOutputText}</span>`;
                    primaryOutputDiv.dataset.plainText = primaryOutputText;
                } else {
                    primaryOutputDiv.innerHTML = '<p class="text-gray-500 italic">è«‹åœ¨å·¦å´å®Œæ•´å¡«å¯«å€å¡Šä¸€è³‡è¨Š</p>';
                    primaryOutputDiv.dataset.plainText = '';
                }

                
                // === å€å¡ŠäºŒå·¥é …æ¸…å–®é‚è¼¯ (Secondary Output) ===
                
                // å–å¾— Block 2 çš„å–®ä¸€è¼¸å…¥å€¼ (ä»¥ç¬¬ä¸€å€‹é–€è™Ÿç‚ºåŸºæº–ä¾†æ¨ç®— Block 2 è®Šå‹•)
                const block2Values = {
                    jingnetStatus: document.getElementById('jingnetStatus').value,
                    originalContract: originalContractSelect.value,
                    paymentType: paymentTypeSelect.value, 
                    simDelivery: simDeliverySelect.value,
                    otherTaskDescription: document.getElementById('otherTaskDescription').value.trim(),
                    // å¸¶å…¥ç¬¬ä¸€å€‹é–€è™Ÿçš„é—œéµè³‡è¨Šçµ¦å·¥é …è¦å‰‡ä½¿ç”¨
                    planStatus: firstLineData ? firstLineData.planStatus : '',
                    telecomProvider: firstLineData ? firstLineData.telecomProvider : '',
                    internetMonths: firstLineData ? firstLineData.internetMonths : '', // å‚³éç¶²è·¯æœˆä»½çµ¦ä¸»æ¥­æ¬Šåˆ¤æ–·
                };


                // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰**å¿…è¦**æ¬„ä½éƒ½æœ‰å€¼ (åŒ…å«æ‰€æœ‰ Block 1 Line + Block 2)
                const requiredBlock2Fields = [
                    'jingnetStatus', 'originalContract', 'paymentType', 'simDelivery'
                ];

                const isBlock2Complete = requiredBlock2Fields.every(key => block2Values[key] !== "");

                const allSelectedForWorkItems = isBlock1Complete && isBlock2Complete;

                if (!allSelectedForWorkItems) {
                    workItemsOutputDiv.innerHTML = '<p class="text-gray-500 italic text-center pt-8">è«‹åœ¨å·¦å´**å®Œæ•´**å¡«å¯«æ‰€æœ‰å®¢æˆ¶è³‡è¨Šï¼Œå·¥é …æœƒå³æ™‚è‡ªå‹•ç”Ÿæˆã€‚</p>';
                    chunghwaMidTermWarning.classList.add('hidden');
                    workItemsOutputDiv.dataset.plainText = '';
                    return;
                }

                // 2. åˆ¤æ–·ç¬¦åˆçš„å·¥é … (ä½¿ç”¨ç¬¬ä¸€å€‹é–€è™Ÿçš„è³‡è¨Šçµåˆ Block 2 çš„è³‡è¨Š)
                let requiredWorkItems = workItemRules
                    .filter(rule => rule.condition(block2Values))
                    .map(rule => ({ name: rule.name, category: rule.category }));

                // 3. è™•ç†äº’æ–¥é‚è¼¯: çµå–® vs é€€è²»
                const hasRefund = requiredWorkItems.some(item => item.category === "Refund");
                if (hasRefund) {
                    requiredWorkItems = requiredWorkItems.filter(item => item.category !== "Settlement");
                }

                // 4. è™•ç†ã€Œå…¶ä»–å·¥é …(è«‹èªªæ˜)ã€
                if (block2Values.otherTaskDescription) {
                    requiredWorkItems.push({ name: `å…¶ä»–(è«‹å¯«ä»»å‹™èªªæ˜): ${block2Values.otherTaskDescription}`, category: "Other" });
                }

                // 5. è™•ç†ä¸­è¯ç´…å­—æé†’
                const isChunghwa = block2Values.telecomProvider === "ä¸­è¯";
                // è­¦å‘Šé‡å°éçºŒç´„çš„ä¸­è¯æƒ…å¢ƒ
                const warningMessage = 'âš ï¸ è‹¥å®¢æˆ¶ç„¡æ³•é…åˆæ™‚é–“è‡³å…¬å¸æ´¾ç…§å–å¡ï¼Œè«‹å¦æ´¾å¡ç¶²ç¶­å–®';
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºéçºŒç´„çš„ä¸­è¯ï¼Œå¦‚æœæ˜¯ï¼Œå‰‡é¡¯ç¤ºè­¦å‘Šã€‚
                if (isChunghwa && block2Values.planStatus !== 'çºŒç´„') {
                    chunghwaMidTermWarning.innerHTML = warningMessage;
                    chunghwaMidTermWarning.classList.remove('hidden');
                } else {
                    chunghwaMidTermWarning.classList.add('hidden');
                }

                // 6. ç”¢ç”Ÿè¼¸å‡º HTML/Text
                const finalWorkItemNames = requiredWorkItems.map(item => item.name);

                if (finalWorkItemNames.length === 0) {
                     workItemsOutputDiv.innerHTML = '<p class="text-gray-500 italic text-center pt-8">ç›®å‰æƒ…å¢ƒä¸‹ç„¡ç‰¹æ®Šå·¥é …éœ€è¦è™•ç†ï¼Œè«‹æª¢æŸ¥è³‡è¨Šã€‚</p>';
                     workItemsOutputDiv.dataset.plainText = '';
                } else {
                    const listHtml = finalWorkItemNames.map(item => 
                        `<li class="flex items-start text-gray-800">
                            <span class="text-green-500 mr-2 mt-0.5 text-lg flex-shrink-0">âœ“</span>
                            <span class="font-medium">${item}</span>
                        </li>`
                    ).join('');
                    
                    workItemsOutputDiv.innerHTML = `<ul class="list-none space-y-2">${listHtml}</ul>`;
                    workItemsOutputDiv.dataset.plainText = finalWorkItemNames.join('\n');
                }
            }


            // --- Helper Functions for Copying ---
            function copyToClipboard(text, buttonElement, messageDiv) {
                if (!text) {
                    messageDiv.textContent = 'âŒ ç„¡å…§å®¹å¯ä¾›è¤‡è£½ï¼';
                    messageDiv.className = 'mt-4 p-3 text-center rounded-lg font-medium shadow-md bg-red-100 text-red-700 block transition-all duration-300';
                    setTimeout(() => messageDiv.classList.add('hidden'), 3000);
                    return;
                }
                
                // Using document.execCommand('copy') for better compatibility in iFrames
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed'; // Avoid scrolling to bottom
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    messageDiv.textContent = `ğŸ“‹ æˆåŠŸè¤‡è£½ã€Œ${buttonElement.textContent.trim()}ã€ï¼`;
                    messageDiv.className = 'mt-4 p-3 text-center rounded-lg font-medium shadow-md bg-green-100 text-green-700 block transition-all duration-300';
                } catch (err) {
                    messageDiv.textContent = 'âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼';
                    messageDiv.className = 'mt-4 p-3 text-center rounded-lg font-medium shadow-md bg-red-100 text-red-700 block transition-all duration-300';
                }
                document.body.removeChild(textarea);
                
                messageDiv.classList.remove('hidden');
                setTimeout(() => messageDiv.classList.add('hidden'), 3000);
            }

            // --- Event Listeners ---
            
            // ç›£è½ Block 2 æ¬„ä½è®Šå‹•
            document.getElementById('jingnetStatus').addEventListener('change', calculateWorkItems);
            originalContractSelect.addEventListener('change', calculateWorkItems);
            paymentTypeSelect.addEventListener('change', calculateWorkItems);
            simDeliverySelect.addEventListener('change', calculateWorkItems);
            document.getElementById('otherTaskDescription').addEventListener('input', calculateWorkItems);


            // è¤‡è£½æŒ‰éˆ•ç›£è½
            copyPrimaryButton.addEventListener('click', () => {
                const text = primaryOutputDiv.dataset.plainText;
                copyToClipboard(text, copyPrimaryButton, confirmationMessage);
            });

            copyWorkItemsButton.addEventListener('click', () => {
                const text = workItemsOutputDiv.dataset.plainText;
                copyToClipboard(text, copyWorkItemsButton, confirmationMessage);
            });

            // === Multi-line control listeners ===
            multipleLinesCheckbox.addEventListener('change', () => {
                const isChecked = multipleLinesCheckbox.checked;
                if (isChecked) {
                    lineCountSelect.disabled = false;
                } else {
                    lineCountSelect.disabled = true;
                    lineCountSelect.value = '1';
                }
                renderPhoneLines(parseInt(lineCountSelect.value));
                calculateWorkItems();
            });

            lineCountSelect.addEventListener('change', () => {
                renderPhoneLines(parseInt(lineCountSelect.value));
                calculateWorkItems();
            });

            // --- Initial Setup ---
            renderPhoneLines(1); // åˆå§‹æ¸²æŸ“ 1 å€‹é–€è™Ÿ
            calculateWorkItems(); // é¦–æ¬¡è¨ˆç®—ä»¥ç¢ºä¿é è¨­å€¼æ­£ç¢º
        });
    </script>
</body>
</html>
