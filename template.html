<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»éŠ· ISP é›»è¯æºé€šæ¨¡æ¿</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons (ç”¨æ–¼ç¾è§€å°ˆæ¥­çš„åœ–æ¨™) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ï¼Œå¢å¼·ç¾è§€æ€§ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* éš±è—åŸç”Ÿ details/summary çš„ç®­é ­ */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .details-icon { transition: transform 0.2s ease-in-out; }
        details[open] .details-icon { transform: rotate(90deg); }
        /* ç¢ºä¿æ¨¡æ…‹æ¡†åœ¨æœ€ä¸Šå±¤ */
        .modal-overlay { z-index: 50; }
        .modal-content { z-index: 51; }
    </style>
</head>
<body>

    <!-- ä¸»å®¹å™¨ï¼šç½®ä¸­ä¸”æœ€å¤§å¯¬åº¦é™åˆ¶ -->
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">
            ISP é›»è¯æºé€šæ¨¡æ¿ <span class="text-base font-medium text-blue-500 ml-3">é›»éŠ·å°ˆç”¨</span>
        </h1>

        <!-- å€å¡Šä¸€ï¼šæ ¸å¿ƒå®¢æˆ¶èˆ‡è«®è©¢å–®è³‡è¨Š (å›ºå®šå€å¡Š) -->
        <div id="client-info" class="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-blue-500">
            
            <!-- æ¨™é¡Œï¼šå·²å°‡æ¨™ç±¤ç§»å‹•è‡³æ­¤è™• -->
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                å®¢æˆ¶è³‡è¨Š (è‡ªå‹•å¸¶å…¥) 
                <i data-lucide="user" class="w-5 h-5 ml-2 text-blue-500"></i>
                <!-- æ¨™ç±¤å·²ç§»è‡³æ­¤è™•ï¼Œæ”¾åœ¨æ¨™é¡Œå³å´ -->
                <span id="status-tag" class="bg-yellow-100 text-yellow-800 text-base font-semibold px-3 py-1 rounded-full ring-2 ring-yellow-400 ml-4">
                    å·²ç´„å·¥å¾…ç”³è£
                </span>
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-y-2 gap-x-6 text-sm">
                
                <!-- 1. å§“å -->
                <div class="flex items-center">
                    <span class="font-medium text-gray-500">å§“å:</span> 
                    <span id="client-name" class="font-bold text-gray-800">ç‹æ›‰æ˜</span>
                </div>
                
                <!-- 2. é›»è©± -->
                <div><span class="font-medium text-gray-500">é›»è©±:</span> <span id="client-phone">09XX-XXX-XXX</span></div>
                
                <!-- 3. ç¤¾å€/åŒ– -->
                <div class="md:col-span-1">
                    <span class="font-medium text-gray-500">ç¤¾å€/åŒ–:</span> <span id="client-community">ä¿¡ç¾©å¤§æ¨“</span> / <span id="client-type" class="font-semibold text-green-600">å…‰åŒ–</span>
                </div>
                
                <!-- 4. åœ°å€ (ä½”æ»¿ä¸€è¡Œ) -->
                <div class="md:col-span-3"><span class="font-medium text-gray-500">åœ°å€:</span> <span id="client-address" class="truncate">å°åŒ—å¸‚ä¿¡ç¾©å€å¿ å­æ±è·¯ä¸€æ®µ 100 è™Ÿ 10 æ¨“</span></div>
                
                <!-- 5. é›»å­éƒµä»¶ (æ–°å¢ï¼Œä½”æ»¿ä¸€è¡Œï¼Œæ¨¡æ“¬è‡ªå‹•å¸¶å…¥) -->
                <div class="md:col-span-3"><span class="font-medium text-gray-500">Email:</span> <span id="client-email" class="text-blue-600 font-semibold">wang.xm@example.com</span></div>
            </div>
            
            <hr class="my-4 border-gray-200">

            <h3 class="text-lg font-semibold text-gray-700 mb-3">è«®è©¢å–®è³‡è¨Š</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div><span class="font-medium text-gray-500">æŒ‡å®šè¯çµ¡æ™‚é–“:</span> <span id="client-schedule" class="text-indigo-600 font-bold">ä»Šå¤©ä¸‹åˆ 14:30 - 15:00</span></div>
                <div class="md:col-span-2">
                    <span class="font-medium text-gray-500">è«®è©¢å–®å‚™è¨»:</span> <span id="client-note" class="text-gray-600 italic">å®¢æˆ¶åæ‡‰ç¶²è·¯é€Ÿåº¦æ…¢ï¼Œè©¢å•æ–°æ–¹æ¡ˆã€‚</span>
                </div>
            </div>
        </div>

        <!-- æºé€šå…§å®¹ç´€éŒ„èˆ‡æ“ä½œå€ -->
        <div class="grid grid-cols-1 lg:col-span-3 gap-6">

            <!-- å·¦å´ï¼šä¸»è¦æºé€šç´€éŒ„èˆ‡å‹¾é¸ (ä½”2/3) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- å€å¡ŠäºŒï¼šæºé€šå…§å®¹ç´€éŒ„ (ä¸»é«”ç´€éŒ„èˆ‡å‹¾é¸) -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">å®¢æˆ¶ç¾æ³èˆ‡å ±åƒ¹</h2>
                    
                    <!-- 1. å®¢æˆ¶ç¾æ³ -->
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">åŸæ¥­è€…è³‡è¨Š & ä½å®¶è³‡è¨Š</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="origin_info" value="ç«¶æ¥­è½‰æ›" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-600">ç«¶æ¥­è½‰æ›</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="origin_info" value="æ–°å…¥ä½" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-600">æ–°å…¥ä½</span>
                            </label>
                            <span class="border-l border-gray-300 mx-2 h-6"></span>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="house_type" value="è‡ªç”¨" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-600">è‡ªç”¨</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="house_type" value="ç§Ÿå±‹" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-600">ç§Ÿå±‹</span>
                            </label>
                        </div>
                    </div>

                    <!-- 2. å ±åƒ¹æ–¹æ¡ˆ -->
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å ±åƒ¹æ–¹æ¡ˆ (å¯è¤‡é¸)</label>
                        <div class="flex flex-wrap gap-6">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="plan" value="$8900/24å€‹æœˆ" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-800 font-bold">$8900/24 å€‹æœˆ</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="plan" value="$6000/14å€‹æœˆ" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-800 font-bold">$6000/14 å€‹æœˆ</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="plan" value="$5400/12å€‹æœˆ" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-800 font-bold">$5400/12 å€‹æœˆ</span>
                            </label>
                        </div>
                    </div>

                    <!-- 3. ç¡¬é«”èˆ‡åªæ•¸ -->
                    <div class="mb-5 border-t pt-4 border-gray-100">
                         <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†äº«å™¨ & åªæ•¸</label>
                         <div class="flex flex-wrap gap-4 items-center">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="hardware" value="åˆ†äº«å™¨è‡ªå‚™" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-600">åˆ†äº«å™¨è‡ªå‚™</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="hardware" value="è€ƒæ…®åŠ è³¼" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-600">è€ƒæ…®åŠ è³¼</span>
                            </label>
                            <span class="border-l border-gray-300 mx-2 h-6"></span>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="area" value="35åªä»¥ä¸‹" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-600">35 åªä»¥ä¸‹</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="area" value="35åªä»¥ä¸Š" class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-600">35 åªä»¥ä¸Š</span>
                            </label>
                        </div>
                        <!-- å…‰è½‰å™¨ï¼šæ¢ä»¶å¼é¡¯ç¤º -->
                        <div id="onu-field" class="mt-3 p-3 bg-indigo-50 rounded-lg hidden">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="hardware" value="å…‰è½‰å™¨" class="rounded text-indigo-600 focus:ring-indigo-500">
                                <span class="text-indigo-700 font-semibold">å…‰è½‰å™¨ (å…‰åŒ–ç¤¾å€å°ˆå±¬ï¼Œè«‹å‹¾é¸)</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- å€å¡ŠäºŒ Bï¼šç¤¾å€èˆ‡ç‰¹æ®Šéœ€æ±‚ -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">ç¤¾å€/å…¬é—œå„ªæƒ èˆ‡é‡è¦æé†’</h2>

                    <div class="mb-5">
                        <label class="flex items-center space-x-2 mb-2">
                            <input type="checkbox" id="community-discount-check" class="rounded text-red-600 focus:ring-red-500">
                            <span class="text-gray-700 font-medium">å·²èªªæ˜ç¤¾å€å„ªæƒ  (å¦‚æœ‰å ±å„ªæƒ éœ€å‹¾é¸)</span>
                        </label>
                        <div id="community-discount-content" class="bg-red-50 p-3 text-sm text-red-700 rounded-lg border border-red-200">
                            <span class="font-bold">ç¤¾å€å„ªæƒ å…§å®¹ï¼š</span>Q2 æœªç”¢å–®é™å®šç¤¾å€è´ˆå“æ´»å‹•ã€2025.09.01~2025.10.31ã€‘è£æ©Ÿè³‡è²» $8,900 è´ˆ 500 é»æ™ºç”Ÿæ´»ç´…åˆ©ï¼Œæ–¼é‘‘è³æœŸéå¾Œä»¥ç°¡è¨Šç™¼é€å…Œæ›åºè™Ÿï¼Œå¯ä½µç”¨æ¥­å‹™æ¬Šé™ä¸€å€‹æœˆã€‚
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç¤¾å€ç‰¹æ®Šå‚™è¨»</label>
                        <!-- (å¯ç·¨è¼¯) å·²ç§»é™¤ -->
                        <div class="bg-blue-50 p-3 text-sm text-blue-700 rounded-lg border border-blue-200">
                            <span class="font-bold">å…§å®¹ï¼š</span>é ˆæå‰è·Ÿè­¦è¡›å®¤å€Ÿé‘°åŒ™
                        </div>
                    </div>

                    <div class="mb-5 border-t pt-4 border-gray-100">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å…¬é—œå„ªæƒ  & å…¶ä»–</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center space-x-2"><input type="checkbox" name="pr_discount" value="å®¢ä»‹" class="rounded text-blue-600"><span>å®¢ä»‹</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" name="pr_discount" value="å®¢å§”å“¡" class="rounded text-blue-600"><span>å®¢å§”å“¡</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" name="pr_discount" value="é•ç´„é‡‘" class="rounded text-blue-600"><span>é•ç´„é‡‘</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" name="pr_discount" value="å…¶ä»–" class="rounded text-blue-600"><span>å…¶ä»–</span></label>
                        </div>
                    </div>

                    <div class="mb-5 p-4 bg-orange-50 border-l-4 border-orange-400 rounded-lg">
                        <span class="font-bold text-orange-700">é‡è¦æé†’:</span> æœ¬äººé ˆå¾…é›™è­‰æ­£æœ¬
                    </div>

                    <!-- å¯å±•é–‹å€å¡Š (Accordion) -->
                    <div class="space-y-3">
                        <details id="toggle-dual-net" class="p-3 bg-gray-50 rounded-lg border cursor-pointer hover:bg-gray-100 transition duration-150">
                            <summary class="flex justify-between items-center text-sm font-medium text-gray-700">
                                é›™ç¶² è³‡è¨Šè¿½è¹¤ <i data-lucide="chevron-right" class="w-5 h-5 details-icon"></i>
                            </summary>
                            <div class="mt-3 space-y-3 p-2 border-t border-gray-200">
                                <div class="flex gap-4">
                                    <label class="block text-sm font-medium text-gray-700">å®¢æˆ¶é–€è™Ÿ:</label>
                                    <div class="flex gap-4">
                                        <label><input type="radio" name="mobile_provider" value="ä¸­è¯" class="text-blue-600">ä¸­è¯</label>
                                        <label><input type="radio" name="mobile_provider" value="é å‚³" class="text-blue-600">é å‚³</label>
                                        <label><input type="radio" name="mobile_provider" value="å°å“¥å¤§" class="text-blue-600">å°å“¥å¤§</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ¶é–€è™Ÿåˆç´„:</label>
                                    <input type="text" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="åˆç´„å…§å®¹æˆ–åˆ°æœŸæ—¥">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ¶é–€è™Ÿè³‡è²»:</label>
                                    <input type="text" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="è³‡è²»æ–¹æ¡ˆ">
                                </div>
                            </div>
                        </details>
                        
                        <details id="toggle-media" class="p-3 bg-gray-50 rounded-lg border cursor-pointer hover:bg-gray-100 transition duration-150">
                            <summary class="flex justify-between items-center text-sm font-medium text-gray-700">
                                å½±è¦–æœå‹™ éœ€æ±‚ <i data-lucide="chevron-right" class="w-5 h-5 details-icon"></i>
                            </summary>
                            <div class="mt-3 space-y-3 p-2 border-t border-gray-200">
                                <label class="block text-sm font-medium text-gray-700 mb-1">å½±è¦–æœå‹™:</label>
                                <div class="flex flex-wrap gap-4">
                                    <label><input type="checkbox" name="video_service" value="LiTV" class="rounded text-blue-600">LiTV</label>
                                    <label><input type="checkbox" name="video_service" value="Hami Video" class="rounded text-blue-600">Hami Video</label>
                                    <label><input type="checkbox" name="video_service" value="å…©ç¨®è€ƒæ…®ä¸­" class="rounded text-blue-600">å…©ç¨®è€ƒæ…®ä¸­</label>
                                </div>
                            </div>
                        </details>

                        <details id="toggle-cleaning" class="p-3 bg-gray-50 rounded-lg border cursor-pointer hover:bg-gray-100 transition duration-150">
                            <summary class="flex justify-between items-center text-sm font-medium text-gray-700">
                                å®¶é›»æ¸…æ´— éœ€æ±‚ <i data-lucide="chevron-right" class="w-5 h-5 details-icon"></i>
                            </summary>
                            <div class="mt-3 space-y-3 p-2 border-t border-gray-200">
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ¸…æ´—é …ç›®:</label>
                                <div class="flex flex-wrap gap-4">
                                    <label><input type="checkbox" name="cleaning_service" value="å®¶é›»å¥è¨º" class="rounded text-blue-600">å®¶é›»å¥è¨º</label>
                                    <label><input type="checkbox" name="cleaning_service" value="å®¶é›»æ¸…æ´—è™•ç†å…§å®¹" class="rounded text-blue-600">å®¶é›»æ¸…æ´—è™•ç†å…§å®¹</label>
                                </div>
                            </div>
                        </details>
                    </div>

                    <!-- å‚™è¨»ï¼šä¸‹æ¬¡è¿½è¹¤æ—¥æœŸæ™‚é–“ -->
                    <div class="mt-6 border-t pt-4">
                        <label for="next-follow-up" class="block text-sm font-medium text-gray-700 mb-1">ä¸‹æ¬¡è¿½è¹¤æ—¥æœŸæ™‚é–“</label>
                        <input type="datetime-local" id="next-follow-up" value="2025-10-30T18:00" class="border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                </div>
            </div>

            <!-- å³å´ï¼šåŠŸèƒ½æ€§æ“ä½œå€ (ä½”1/3) -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- å€å¡Šä¸‰ï¼šåŠŸèƒ½æ€§æ“ä½œ -->
                <div class="bg-white p-6 rounded-xl shadow-lg sticky top-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">å¿«é€Ÿæ“ä½œå€</h2>

                    <div class="space-y-4">
                        <button onclick="showModal('transfer')" class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                            <i data-lucide="git-branch" class="w-5 h-5 mr-2"></i> è½‰å–®
                        </button>
                        <button onclick="showModal('sms')" class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                            <i data-lucide="message-square" class="w-5 h-5 mr-2"></i> ç°¡è¨Šç™¼é€
                        </button>
                        <button onclick="showModal('mail')" class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                            <i data-lucide="mail" class="w-5 h-5 mr-2"></i> Mail ç™¼é€
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å€å¡Šå››ï¼šçµå–®èˆ‡è¿½è¹¤ (åº•éƒ¨å›ºå®šåˆ¤æ–·) -->
        <div class="mt-8 bg-white p-6 rounded-xl shadow-xl border-b-4 border-red-500">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">çµå–®å‰é ˆé»é¸ (æµç¨‹åˆ¤æ–·)</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- åˆ¤æ–·åŸå›  1 -->
                <div>
                    <label for="reason-1" class="block text-sm font-medium text-gray-700 mb-1">åˆ¤æ–·åŸå›  1 (çµå–®ä¸»åˆ†é¡)</label>
                    <select id="reason-1" onchange="handleClosureReasonChange(this.value)" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-red-500 focus:border-red-500">
                        <option value="" disabled selected>-- è«‹é¸æ“‡çµå–®åŸå›  --</option>
                        <option value="å·²ç´„å·¥">âœ… å·²ç´„å·¥ (ç›´æ¥é€²å…¥ç´„å·¥ç³»çµ±)</option>
                        <option value="éœ€è¿½è¹¤">ğŸ•’ éœ€è¿½è¹¤</option>
                        <option value="æœªç”³è£">âŒ æœªç”³è£</option>
                        <option value="ç„¡æ•ˆå–®">ğŸ—‘ï¸ ç„¡æ•ˆå–®</option>
                    </select>
                </div>

                <!-- åˆ¤æ–·åŸå›  2 (æ¢ä»¶å¼é¡¯ç¤º) -->
                <div id="reason-2-container" class="hidden">
                    <label for="reason-2" class="block text-sm font-medium text-gray-700 mb-1">åˆ¤æ–·åŸå›  2 (è©³ç´°åŸå› )</label>
                    <select id="reason-2" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm bg-gray-50 focus:ring-red-500 focus:border-red-500">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>
            
            <!-- å„²å­˜æŒ‰éˆ• -->
            <div class="mt-6 flex justify-end">
                <button id="save-button" onclick="saveRecord()" class="px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                    <i data-lucide="save" class="w-5 h-5 inline-block mr-2"></i> å„²å­˜
                </button>
            </div>
        </div>
    </div>


    <!-- æ¨¡æ…‹æ¡† (è½‰å–®/ç°¡è¨Š/Mail) -->
    <div id="modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden modal-overlay">
        <div id="transfer-modal" class="hidden bg-white rounded-xl shadow-2xl p-8 max-w-lg mx-auto my-12 modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">è½‰å–®ä½œæ¥­</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è½‰å‡ºéƒ¨é–€</label>
                    <select id="transfer-department" class="w-full border border-gray-300 rounded-lg p-2.5">
                        <option>é›»éŠ·</option><option>æ¥­å‹™</option><option>å®¢æœ</option><option>ç¶²ç®¡</option><option>é›»å•†</option><option>æŠ€è¡“å®¢æœ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ¶éœ€æ±‚</label>
                    <select id="transfer-demand" class="w-full border border-gray-300 rounded-lg p-2.5">
                        <option>è£æ©Ÿè«®è©¢</option><option>å¸³å‹™å•é¡Œ</option><option>æ™ºç”Ÿæ´»ç³»çµ±å•é¡Œ</option><option>ç¶²è·¯éšœç¤™å•é¡Œ</option><option>æ™ºç”Ÿæ´»å•†å“å•é¡Œ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»</label>
                    <textarea id="transfer-note" rows="3" class="w-full border border-gray-300 rounded-lg p-2.5"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button onclick="hideModal()" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100">å–æ¶ˆ</button>
                    <button onclick="submitTransfer()" class="px-4 py-2 border rounded-lg text-white bg-green-600 hover:bg-green-700">é€å‡º (è½‰å‡º)</button>
                </div>
            </div>
        </div>

        <div id="sms-modal" class="hidden bg-white rounded-xl shadow-2xl p-8 max-w-lg mx-auto my-12 modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">ç°¡è¨Šç™¼é€</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ¶æ‰‹æ©Ÿè™Ÿç¢¼</label>
                    <input type="text" id="sms-phone" value="09XX-XXX-XXX" class="w-full border border-gray-300 rounded-lg p-2.5">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç½é ­ç°¡è¨Šå…§å®¹</label>
                    <select id="sms-template" onchange="loadSmsTemplate(this.value)" class="w-full border border-gray-300 rounded-lg p-2.5">
                        <option value="" disabled selected>-- é¸æ“‡æ¨¡æ¿ --</option>
                        <option value="æœªæ¥">å®¢æˆ¶æœªæ¥</option>
                        <option value="å¤±è¯">å®¢æˆ¶å¤±è¯</option>
                        <option value="ç· çµ">å®¢æˆ¶å·²ç· çµ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å…§å®¹ç·¨è¼¯å€</label>
                    <textarea id="sms-content" rows="4" class="w-full border border-gray-300 rounded-lg p-2.5"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button onclick="hideModal()" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100">å–æ¶ˆ</button>
                    <button onclick="sendSms()" class="px-4 py-2 border rounded-lg text-white bg-blue-600 hover:bg-blue-700">ç™¼é€</button>
                </div>
            </div>
        </div>

        <div id="mail-modal" class="hidden bg-white rounded-xl shadow-2xl p-8 max-w-lg mx-auto my-12 modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Mail ç™¼é€</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ”¶ä»¶äºº Mail</label>
                    <!-- mail-to çš„å€¼æœƒè¢« JS è‡ªå‹•å¸¶å…¥å®¢æˆ¶ Email -->
                    <input type="email" id="mail-to" placeholder="è«‹è¼¸å…¥å®¢æˆ¶ Email" class="w-full border border-gray-300 rounded-lg p-2.5">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">éƒµä»¶æ¨¡æ¿</label>
                    <select id="mail-template" onchange="loadMailTemplate(this.value)" class="w-full border border-gray-300 rounded-lg p-2.5">
                        <option value="" disabled selected>-- é¸æ“‡æ¨¡æ¿ --</option>
                        <option value="å·²ç· çµ">ISP å·²ç· çµ (æ–¹æ¡ˆç¢ºèªä¿¡)</option>
                        <option value="æœªç· çµ">ISP æœªç· çµ (å ±åƒ¹å–®)</option>
                        <option value="è€ƒæ…®ä¸­">ISP è€ƒæ…®ä¸­ (è³‡è¨Šå½™æ•´)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å…§å®¹ç·¨è¼¯å€</label>
                    <textarea id="mail-content" rows="6" class="w-full border border-gray-300 rounded-lg p-2.5"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button onclick="hideModal()" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100">å–æ¶ˆ</button>
                    <button onclick="sendMail()" class="px-4 py-2 border rounded-lg text-white bg-indigo-600 hover:bg-indigo-700">ç™¼é€</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ç¢ºä¿ Lucide åœ–æ¨™æ­£ç¢ºåˆå§‹åŒ–
        lucide.createIcons();

        // åˆ¤æ–·åŸå›  2 çš„é¸é …
        const REASON_2_OPTIONS = {
            'æœªç”³è£': [
                "çŸ­ç¹³/æœˆç¹³/é è²»æ–¹å¼", "åƒ¹æ ¼/å„ªæƒ å› ç´ ", "ä¸ç¬¦éœ€æ±‚", "é•ç´„é‡‘éé«˜", 
                "å ±åƒ¹å¾Œå¤±è¯", "è¨­å‚™éœ€è‡ªè³¼", "ç¬¬å››å°éœ€æ±‚", "å½±è¦–é ˆåŠ è³¼", "å®¢æˆ¶ä¸å¸Œæœ›å†å»é›»"
            ],
            'ç„¡æ•ˆå–®': [
                "é‡è¤‡å–®", "æ¸¬è©¦", "åŸç”¨æˆ¶ç¶²è·¯/å¸³å‹™å•é¡Œè«®è©¢", "è¯çµ¡è³‡è¨ŠéŒ¯èª¤", 
                "å¤±è¯(é›»è¯å¤šæ¬¡æœªæ¥)", "æ™ºç”Ÿæ´»/ç®¡ç†å®¤å•é¡Œè«®è©¢"
            ]
        };

        // ç°¡è¨Š/Mail ç½é ­å…§å®¹
        const TEMPLATE_CONTENT = {
            'æœªæ¥': 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯[å…¬å¸]çš„[å§“å]ï¼Œå‰›æ‰æœªèƒ½æˆåŠŸè¯ç¹«åˆ°æ‚¨ï¼Œæˆ‘å€‘å°‡ç¨å¾Œå†æ’¥ã€‚è¬è¬ï¼',
            'å¤±è¯': 'æ‚¨å¥½ï¼Œæˆ‘å€‘å·²å˜—è©¦è¯ç¹«æ‚¨æ•¸æ¬¡æœªæœï¼Œè«‹æ–¹ä¾¿æ™‚å›æ’¥é›»è©±æˆ–å›è¦†æ­¤ç°¡è¨Šã€‚è¬è¬ã€‚',
            'ç· çµ': 'æ­å–œæ‚¨å®Œæˆç”³è£ï¼æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„è¨‚å–®ï¼Œå°‡ç”±å°ˆäººèˆ‡æ‚¨è¯ç¹«ç¢ºèªç´°ç¯€ï¼Œè¬è¬æ‚¨çš„æ”¯æŒã€‚',
            'å·²ç· çµ': 'ã€ISP æ–¹æ¡ˆç¢ºèªä¿¡ã€‘\n\n[å®¢æˆ¶å§“å]æ‚¨å¥½ï¼Œæ„Ÿè¬æ‚¨çš„ç”³è¾¦ã€‚æ‚¨æœ¬æ¬¡é¸æ“‡çš„æ–¹æ¡ˆç‚º [æ–¹æ¡ˆåç¨±]ï¼Œåˆç´„ç´°ç¯€è«‹åƒè€ƒé™„ä»¶ã€‚',
            'æœªç· çµ': 'ã€ISP å ±åƒ¹è³‡è¨Šå½™æ•´ã€‘\n\n[å®¢æˆ¶å§“å]æ‚¨å¥½ï¼Œé€™æ˜¯æ‚¨æœ¬æ¬¡è«®è©¢çš„ [æ–¹æ¡ˆåç¨±] å ±åƒ¹å–®èˆ‡æœå‹™èªªæ˜ï¼Œè«‹æŸ¥é–±ã€‚',
            'è€ƒæ…®ä¸­': 'ã€ISP è³‡è¨Šå½™æ•´ã€‘\n\n[å®¢æˆ¶å§“å]æ‚¨å¥½ï¼Œé€™æ˜¯æˆ‘å€‘ç‚ºæ‚¨æ•´ç†çš„æœå‹™è³‡è¨Šèˆ‡å„ªæƒ å…§å®¹ï¼Œå¸Œæœ›èƒ½å”åŠ©æ‚¨åšå‡ºæœ€å¥½çš„é¸æ“‡ã€‚å¦‚æœ‰ä»»ä½•ç–‘å•ï¼Œæ­¡è¿éš¨æ™‚ä¾†é›»ã€‚',
        };

        // ä»‹é¢åˆå§‹åŒ–æª¢æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            checkCommunityType();
        });

        /**
         * æª¢æŸ¥å®¢æˆ¶é¡å‹ (ä¹™å¤ª/å…‰åŒ–)ï¼Œæ±ºå®šæ˜¯å¦é¡¯ç¤ºã€Œå…‰è½‰å™¨ã€æ¬„ä½ã€‚
         */
        function checkCommunityType() {
            const clientType = document.getElementById('client-type').textContent.trim();
            const onuField = document.getElementById('onu-field');
            if (clientType === 'å…‰åŒ–') {
                onuField.classList.remove('hidden');
            } else {
                onuField.classList.add('hidden');
            }
        }

        /**
         * è™•ç†çµå–®åŸå›  1 çš„è®Šå‹•ï¼Œä¸¦é€£å‹•é¡¯ç¤º/éš±è—/æ›´æ–°åˆ¤æ–·åŸå›  2 çš„é¸é …ã€‚
         * @param {string} value - é¸æ“‡çš„åˆ¤æ–·åŸå›  1 å€¼
         */
        function handleClosureReasonChange(value) {
            const reason2Container = document.getElementById('reason-2-container');
            const reason2Select = document.getElementById('reason-2');
            
            // æ¸…ç©ºæ‰€æœ‰èˆŠé¸é …
            reason2Select.innerHTML = '<option value="" disabled selected>-- è«‹é¸æ“‡è©³ç´°åŸå›  --</option>';

            if (value === 'å·²ç´„å·¥') {
                // æ¨¡æ“¬é€²å…¥ç´„å·¥ç³»çµ±çš„æµç¨‹ (å¯¦å‹™ä¸Šæœƒå°é æˆ–è§¸ç™¼å¾Œç«¯ API)
                alert('å·²ç´„å·¥ï¼šç³»çµ±å°å‘ã€Œç´„å·¥æ’ç¨‹ä»‹é¢ã€');
                reason2Container.classList.add('hidden');
                return;
            } else if (value === 'éœ€è¿½è¹¤') {
                // åƒ…éœ€è¿½è¹¤ï¼Œä¸éœ€åŸå›  2
                reason2Container.classList.add('hidden');
            } else if (REASON_2_OPTIONS[value]) {
                // é¡¯ç¤ºåŸå›  2 å®¹å™¨
                reason2Container.classList.remove('hidden');
                
                // è¼‰å…¥å°æ‡‰çš„åŸå›  2 é¸é …
                REASON_2_OPTIONS[value].forEach(reason => {
                    const option = document.createElement('option');
                    option.value = reason;
                    option.textContent = reason;
                    reason2Select.appendChild(option);
                });
            } else {
                reason2Container.classList.add('hidden');
            }
        }

        /**
         * é¡¯ç¤ºæ¨¡æ…‹æ¡† (è½‰å–®/ç°¡è¨Š/Mail)
         * @param {string} modalId - è¦é¡¯ç¤ºçš„æ¨¡æ…‹æ¡† ID (transfer, sms, mail)
         */
        function showModal(modalId) {
            hideModal(); // ç¢ºä¿å…¶ä»–æ¨¡æ…‹æ¡†å·²éš±è—
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById(`${modalId}-modal`).classList.remove('hidden');
            document.getElementById(`${modalId}-modal`).parentNode.classList.add('flex', 'items-center', 'justify-center');
            
            // --- é‡å° Mail æ¨¡æ…‹æ¡†ï¼šè‡ªå‹•å¸¶å…¥å®¢æˆ¶ Email ---
            if (modalId === 'mail') {
                const clientEmailElement = document.getElementById('client-email');
                const mailToInput = document.getElementById('mail-to');
                
                if (clientEmailElement && mailToInput) {
                    const clientEmail = clientEmailElement.textContent.trim();
                    mailToInput.value = clientEmail; // è‡ªå‹•å¸¶å…¥ Email
                }
            }
            // ------------------------------------------
        }

        /**
         * éš±è—æ‰€æœ‰æ¨¡æ…‹æ¡†
         */
        function hideModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('transfer-modal').classList.add('hidden');
            document.getElementById('sms-modal').classList.add('hidden');
            document.getElementById('mail-modal').classList.add('hidden');
            document.getElementById('transfer-modal').parentNode.classList.remove('flex', 'items-center', 'justify-center');
        }

        /**
         * è¼‰å…¥ç°¡è¨Šç½é ­å…§å®¹
         * @param {string} templateKey - æ¨¡æ¿çš„ key (æœªæ¥, å¤±è¯, ç· çµ)
         */
        function loadSmsTemplate(templateKey) {
            document.getElementById('sms-content').value = TEMPLATE_CONTENT[templateKey] || '';
        }

        /**
         * è¼‰å…¥ Mail æ¨¡æ¿å…§å®¹
         * @param {string} templateKey - æ¨¡æ¿çš„ key (å·²ç· çµ, æœªç· çµ, è€ƒæ…®ä¸­)
         */
        function loadMailTemplate(templateKey) {
            document.getElementById('mail-content').value = TEMPLATE_CONTENT[templateKey] || '';
        }

        // æ¨¡æ…‹æ¡†åŠŸèƒ½æ¨¡æ“¬
        function submitTransfer() {
            const dept = document.getElementById('transfer-department').value;
            const demand = document.getElementById('transfer-demand').value;
            console.log(`è½‰å–®è‡³éƒ¨é–€: ${dept}, éœ€æ±‚: ${demand}`);
            alert(`å·²æˆåŠŸå°‡æ­¤å–®è½‰å‡ºè‡³ ${dept} éƒ¨é–€è™•ç†ã€‚`);
            hideModal();
        }
        
        function sendSms() {
            const phone = document.getElementById('sms-phone').value;
            const content = document.getElementById('sms-content').value;
            console.log(`ç™¼é€ç°¡è¨Šè‡³ ${phone}, å…§å®¹: ${content}`);
            alert(`ç°¡è¨Šå·²ç™¼é€è‡³ ${phone}`);
            hideModal();
        }

        function sendMail() {
            const email = document.getElementById('mail-to').value;
            const content = document.getElementById('mail-content').value;
            console.log(`ç™¼é€ Mail è‡³ ${email}, å…§å®¹: ${content}`);
            alert(`Mail å·²ç™¼é€è‡³ ${email}`);
            hideModal();
        }


        /**
         * å„²å­˜ç´€éŒ„ (æ ¸å¿ƒåŠŸèƒ½ï¼Œæ¨¡æ“¬è³‡æ–™æ”¶é›†èˆ‡å„²å­˜)
         */
        function saveRecord() {
            // æª¢æŸ¥çµå–®åˆ¤æ–·æ˜¯å¦å®Œæˆ
            const reason1 = document.getElementById('reason-1').value;
            if (!reason1) {
                alert('çµå–®å‰è«‹å‹™å¿…é»é¸ã€Œåˆ¤æ–·åŸå›  1ã€ï¼');
                return;
            }

            // æ”¶é›†æ‰€æœ‰æ•¸æ“š (åƒ…ç‚ºç¯„ä¾‹ï¼Œå¯¦éš›æ‡‰çµ„ç¹”ç‚º JSON çµæ§‹)
            const followUpDate = document.getElementById('next-follow-up').value;
            const clientInfo = {
                name: document.getElementById('client-name').textContent,
                communityType: document.getElementById('client-type').textContent,
                statusTag: document.getElementById('status-tag').textContent.trim()
            };
            
            const closureData = {
                reason1: reason1,
                reason2: reason1 === 'æœªç”³è£' || reason1 === 'ç„¡æ•ˆå–®' ? document.getElementById('reason-2').value : 'N/A',
                nextFollowUp: followUpDate
            };
            
            console.log("--- ç´€éŒ„å·²å„²å­˜ ---");
            console.log("å®¢æˆ¶è³‡è¨Š:", clientInfo);
            console.log("çµå–®æ•¸æ“š:", closureData);
            alert('æºé€šç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼');
        }

    </script>

</body>
</html>
